<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Visualiza tu vida en semanas.">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Tu Vida en Semanas</title>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Reset & Base */
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    body { margin: 0; overflow-x: hidden; min-height: 100dvh; background-color: #f8fafc; }
    #root { min-height: 100dvh; position: relative; z-index: 1; }

    /* Animated Background Mesh */
    .mesh-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0) 0%, rgba(0,0,0,0.02) 100%);
      overflow: hidden; pointer-events: none;
    }
    .mesh-blob {
      position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6;
      animation: floatBlob 20s infinite ease-in-out;
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--blob-1); animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: var(--blob-2); animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: var(--blob-3); animation-delay: -10s; }

    @keyframes floatBlob {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    /* UI Utilities */
    .safe-bottom { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
    .glass { 
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); 
      background: rgba(255, 255, 255, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .fade-in { animation: fadeIn .5s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px);} to { opacity:1; transform: translateY(0);} }
    .wiggle { animation: wiggle 6s ease-in-out infinite; }
    @keyframes wiggle { 0%,100% { transform: rotate(-1deg);} 50% { transform: rotate(1deg);} }

    input[type="date"] { -webkit-appearance: none; min-height: 52px; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState, useCallback, useRef, memo } = React;

    // --- UTILS ---
    const KEYS = { session: "wol_session_v3", users: "wol_users_v3" };
    const safeGet = (k) => { try { return localStorage.getItem(k); } catch { return null; } };
    const safeSet = (k, v) => { try { localStorage.setItem(k, v); } catch {} };
    const loadJSON = (k, fb) => { const r = safeGet(k); if (!r) return fb; try { return JSON.parse(r); } catch { return fb; } };
    const saveJSON = (k, o) => safeSet(k, JSON.stringify(o));
    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
    const fmtInt = (n) => Math.round(n).toLocaleString(undefined);
    
    function parseISODateToLocalMidnight(iso) {
      if (!iso) return null;
      const [y, m, d] = iso.split("-").map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d, 0, 0, 0, 0);
    }
    function isoToday() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
    }

    // --- DATA & THEMES ---
    const THEMES = {
      minimal: { label:{es:"Minimal",en:"Minimal"}, 
        bgClass:"bg-slate-50", blobs:["#e2e8f0","#f1f5f9","#cbd5e1"], 
        text:"text-slate-900", textSec:"text-slate-500", border:"border-slate-200", 
        hex:{ text:"#0f172a", textSec:"#64748b", past:"#334155", future:"#cbd5e1", current:"#3b82f6", accent:"#0f172a" } },
      
      dark: { label:{es:"Oscuro",en:"Dark"}, 
        bgClass:"bg-slate-950 dark", blobs:["#1e293b","#0f172a","#334155"], 
        text:"text-slate-50", textSec:"text-slate-400", border:"border-slate-800", 
        hex:{ text:"#f8fafc", textSec:"#94a3b8", past:"#6366f1", future:"#1e293b", current:"#22d3ee", accent:"#6366f1" } },
      
      ocean: { label:{es:"Océano",en:"Ocean"}, 
        bgClass:"bg-cyan-50", blobs:["#a5f3fc","#cffafe","#22d3ee"], 
        text:"text-cyan-950", textSec:"text-cyan-700", border:"border-cyan-200", 
        hex:{ text:"#083344", textSec:"#0e7490", past:"#0891b2", future:"#cffafe", current:"#06b6d4", accent:"#0e7490" } },
      
      rose: { label:{es:"Rosa",en:"Rose"}, 
        bgClass:"bg-rose-50", blobs:["#fecdd3","#ffe4e6","#fb7185"], 
        text:"text-rose-950", textSec:"text-rose-700", border:"border-rose-200", 
        hex:{ text:"#4c0519", textSec:"#be123c", past:"#e11d48", future:"#ffe4e6", current:"#fb7185", accent:"#e11d48" } },
      
      sunset: { label:{es:"Atardecer",en:"Sunset"}, 
        bgClass:"bg-orange-50", blobs:["#fed7aa","#ffedd5","#fdba74"], 
        text:"text-orange-950", textSec:"text-orange-700", border:"border-orange-200", 
        hex:{ text:"#431407", textSec:"#9a3412", past:"#ea580c", future:"#ffedd5", current:"#f97316", accent:"#ea580c" } },
    };

    const MOODS = [
      { id:"happy", label:{es:"Feliz", en:"Happy"}, color:"#22c55e" },
      { id:"calm", label:{es:"Calmado", en:"Calm"}, color:"#06b6d4" },
      { id:"focused", label:{es:"Enfocado", en:"Focused"}, color:"#3b82f6" },
      { id:"grateful", label:{es:"Agradecido", en:"Grateful"}, color:"#eab308" },
      { id:"tired", label:{es:"Cansado", en:"Tired"}, color:"#737373" },
      { id:"sad", label:{es:"Triste", en:"Sad"}, color:"#6366f1" },
      { id:"angry", label:{es:"Enfadado", en:"Angry"}, color:"#ef4444" },
      { id:"anxious", label:{es:"Ansioso", en:"Anxious"}, color:"#f97316" },
    ];

    // --- INSIGHT POOLS (Randomized Content) ---
    const INSIGHT_POOLS = {
      societal: {
        es: [
          (c) => `La población mundial creció de ~${fmtInt(c.popBirth)} a ~${fmtInt(c.popNow)} durante tu vida.`,
          (c) => `Se estima que ha habido ${fmtInt(c.births)} nacimientos en el mundo desde que tú naciste.`,
          (c) => `En tu vida, la humanidad ha generado más datos digitales que en toda la historia previa junta.`,
          (c) => `Estadísticamente, te has cruzado con unas 80,000 personas, aunque solo recuerdes a unas pocas.`
        ],
        en: [
          (c) => `World population grew from ~${fmtInt(c.popBirth)} to ~${fmtInt(c.popNow)} during your lifetime.`,
          (c) => `There have been approx. ${fmtInt(c.births)} births globally since you were born.`,
          (c) => `During your life, humanity generated more data than in all previous history combined.`,
          (c) => `Statistically, you've walked past ~80,000 people, even if you only remember a few.`
        ]
      },
      cosmic: {
        es: [
          (s) => `Has viajado ${fmtInt(s.earthKm)} km alrededor del Sol.`,
          (s) => `El sistema solar se ha movido ${fmtInt(s.solarKm)} km a través de la Vía Láctea desde tu nacimiento.`,
          (s) => `Tu vida representa el ${s.uniPct.toExponential(2)}% de la edad del universo. Un destello.`,
          (s) => `La luz de las estrellas que ves hoy salió de ellas cuando estabas aprendiendo a caminar.`
        ],
        en: [
          (s) => `You have traveled ${fmtInt(s.earthKm)} km around the Sun.`,
          (s) => `The solar system moved ${fmtInt(s.solarKm)} km through the Milky Way since your birth.`,
          (s) => `Your life represents ${s.uniPct.toExponential(2)}% of the universe's age. A spark.`,
          (s) => `The starlight you see tonight left its source when you were learning to walk.`
        ]
      },
      nature: {
        es: [
          (s) => `Has vivido ${s.seasons} estaciones. El ciclo se repite, pero tú cambias.`,
          (s) => `Tu corazón ha latido aprox. ${fmtInt(s.heart)} veces sin que se lo pidas.`,
          (s) => `Has respirado unas ${fmtInt(s.breaths)} veces.`,
          (s) => `Casi todas tus células se han renovado múltiples veces. Físicamente, eres nuevo.`
        ],
        en: [
          (s) => `You have lived through ${s.seasons} seasons. The cycle repeats, but you change.`,
          (s) => `Your heart has beaten approx. ${fmtInt(s.heart)} times without being asked.`,
          (s) => `You have taken around ${fmtInt(s.breaths)} breaths.`,
          (s) => `Almost all your cells have renewed multiple times. Physically, you are new.`
        ]
      }
    };

    const I18N = {
      es: {
        appTitle:"Tu vida en semanas", appSubtitle:"Visualiza tu tiempo finito.",
        next:"Siguiente", settings:"Ajustes", close:"Cerrar", save:"Guardar",
        language:"Idioma", theme:"Tema", design:"Diseño", profile:"Perfil",
        exportData:"Exportar / Copia", importData:"Importar", copy:"Copiar código", copied:"¡Copiado!",
        weeksLived:"Semanas vividas", lifeProgress:"Tu Progreso", weeksLeft:"semanas restantes",
        moodTodayTitle:"¿Cómo estás hoy?", moodLogNow:"Registrar ánimo",
        highlights:"Puntos destacados", societal:"Contexto global", cosmic:"Perspectiva cósmica", nature:"Naturaleza",
        birthdayTitle:"¡Feliz Cumpleaños!", birthdayMsg: "Hoy la Tierra completa otra vuelta contigo. Respira.",
        onboardingTitle:"Memento Mori", onboardingSubtitle:"Tu tiempo es el recurso más valioso. Visualízalo.",
        login:"Entrar", register:"Crear", username:"Usuario", password:"Contraseña",
        setBirthdate:"Fecha de Nacimiento", done:"Continuar", back:"Volver",
        exportHint: "Copia este código para llevar tus datos a otro móvil.",
        importPlaceholder: "Pega el código aquí...", importBtn:"Restaurar datos"
      },
      en: {
        appTitle:"Your life in weeks", appSubtitle:"Visualize your finite time.",
        next:"Next", settings:"Settings", close:"Close", save:"Save",
        language:"Language", theme:"Theme", design:"Design", profile:"Profile",
        exportData:"Export / Backup", importData:"Import", copy:"Copy Code", copied:"Copied!",
        weeksLived:"Weeks lived", lifeProgress:"Your Progress", weeksLeft:"weeks left",
        moodTodayTitle:"How are you today?", moodLogNow:"Log mood",
        highlights:"Highlights", societal:"Global Context", cosmic:"Cosmic Perspective", nature:"Nature",
        birthdayTitle:"Happy Birthday!", birthdayMsg: "The Earth completes another round with you. Breathe.",
        onboardingTitle:"Memento Mori", onboardingSubtitle:"Your time is your most valuable asset. Visualize it.",
        login:"Login", register:"Sign Up", username:"Username", password:"Password",
        setBirthdate:"Date of Birth", done:"Continue", back:"Back",
        exportHint: "Copy this code to transfer data to another device.",
        importPlaceholder: "Paste code here...", importBtn:"Restore data"
      }
    };

    // --- ICONS ---
    const Icon = ({ name, className }) => {
      const cls = className || "w-5 h-5";
      if(name==="settings") return <svg className={cls} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
      if(name==="x") return <svg className={cls} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
      if(name==="chevron") return <svg className={cls} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>;
      return null;
    }

    // --- COMPONENTS ---
    const Accordion = ({ title, children, defaultOpen=false, tc, id }) => {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className={`glass rounded-2xl mb-3 overflow-hidden transition-all duration-300 shadow-sm ${open ? 'ring-1 ring-black/5' : ''}`}>
          <button onClick={() => setOpen(!open)} className={`w-full px-5 py-4 flex items-center justify-between ${tc.text}`}>
            <span className="font-semibold text-sm tracking-wide">{title}</span>
            <div className={`transition-transform duration-300 ${open ? 'rotate-180' : ''}`}><Icon name="chevron"/></div>
          </button>
          <div className={`transition-all duration-300 ease-in-out px-5 overflow-hidden ${open ? "max-h-96 pb-5 opacity-100" : "max-h-0 opacity-0"}`}>
             {children}
          </div>
        </div>
      );
    };

    // --- LOGIC ---
    function computeStats(birthISO) {
      const birth = parseISODateToLocalMidnight(birthISO);
      if (!birth) return null;
      const now = new Date();
      if (birth > now) return { invalid: true };

      const diffMs = now - birth;
      const daysLived = Math.floor(diffMs / 86400000);
      const weeksLived = Math.floor(diffMs / (86400000 * 7));
      const totalWeeks = 4160; // 80 years
      const weeksLivedClamped = clamp(weeksLived, 0, totalWeeks);
      
      return {
        birth, now,
        weeksLived, weeksLivedClamped, totalWeeks,
        weeksRemaining: Math.max(0, totalWeeks - weeksLivedClamped),
        percentageLived: clamp(Math.round((weeksLivedClamped / totalWeeks) * 100), 0, 100),
        daysLived,
        yearsLived: Math.floor(daysLived/365.25),
        monthsLived: Math.floor((daysLived % 365.25)/30.44),
        // Datos curiosos
        heart: Math.floor(diffMs/60000 * 72),
        breaths: Math.floor(diffMs/60000 * 16),
        seasons: Math.floor(daysLived / 91.3),
        earthKm: (daysLived/365.25) * 940000000,
        solarKm: (diffMs/1000) * 220,
        uniPct: ((daysLived/365.25) / 13800000000) * 100,
        // Contexto Social (Global approx)
        popBirth: 6900000000 + ( (birth.getFullYear()-2010) * 80000000 ), // Estimacion burda pero funcional para rango
        popNow: 8100000000,
        births: (daysLived/365.25) * 140000000
      };
    }

    // --- VISUALIZERS (FIXED WAVE & ADAPTIVE AGE) ---
    const Visualizer = memo(({ type, stats, colors }) => {
      const { weeksLivedClamped: lived, totalWeeks } = stats;
      const W=340, H=340, cx=W/2, cy=H/2;
      
      const getColor = (i) => {
        if (i < lived) return colors.hex.past;
        if (i === lived) return colors.hex.current;
        return colors.hex.future;
      };

      // 1. Grid (Optimized CSS Grid)
      if (type === "grid") {
        return (
          <div className="w-full max-w-[340px] mx-auto grid gap-[1px]" style={{ gridTemplateColumns: `repeat(52, 1fr)` }}>
            {Array.from({length:totalWeeks}).map((_,i) => (
              <div key={i} style={{backgroundColor:getColor(i), aspectRatio:'1/1'}} 
                   className={`rounded-[0.5px] ${i===lived ? 'animate-pulse scale-150 z-10 shadow-sm' : ''}`} />
            ))}
          </div>
        );
      }

      // 2. Wave (FIXED: SVG Audio visualizer style)
      if (type === "wave") {
        // Creamos 80 barras (años) compuestas de segmentos o simplemente 80 barras de altura variable
        // Para que sean semanas, es mucho. Mejor: 52 columnas x 80 filas simulando onda?
        // Mejor enfoque: Barras verticales que forman una onda seno.
        const bars = [];
        const cols = 52; 
        const rows = 80;
        // Vamos a hacer una visualización "Audio Spectrum" estilizada
        // Cada columna es un año (simplificado para que entre en pantalla) o cada punto una semana
        // Haremos 52 barras (columnas) y dentro apilamos bloques
        return (
           <div className="flex items-end justify-center h-[300px] gap-[2px] mx-auto max-w-md opacity-90">
             {Array.from({length: 52}).map((_, col) => {
                // Altura basada en seno para hacer la "ola"
                const heightMod = Math.sin(col * 0.2) * 40 + 60; // 20% a 100%
                const weekIdxStart = col * 80; // Distribución aproximada
                const active = lived > weekIdxStart;
                return (
                  <div key={col} className="w-full flex flex-col justify-end gap-[1px]" style={{height: `${heightMod}%`}}>
                    {Array.from({length: 10}).map((_, row) => {
                       // Subdivisión de la barra
                       const blockIdx = col * 10 + row; // Indice ficticio para color
                       const pct = blockIdx / 520; // 0 a 1
                       const isPast = pct < (stats.percentageLived/100);
                       return (
                         <div key={row} className="flex-1 rounded-[1px] w-full" 
                              style={{ backgroundColor: isPast ? colors.hex.past : colors.hex.future, opacity: isPast?1:0.4 }}></div>
                       )
                    })}
                  </div>
                )
             })}
           </div>
        )
      }

      // 3. Radial Types (Center Age)
      if (["circle","spiral","constellation"].includes(type)) {
        let els = [];
        if (type === "circle") {
          const rings=80, perRing=52;
          for(let y=0; y<rings; y++) {
             const r = 40 + (120/rings)*y;
             for(let w=0; w<perRing; w++) {
                const idx = y*perRing + w;
                const ang = (w/perRing)*Math.PI*2 - Math.PI/2;
                els.push(<circle key={idx} cx={cx+r*Math.cos(ang)} cy={cy+r*Math.sin(ang)} r={idx===lived?2.5:1.2} fill={getColor(idx)} />);
             }
          }
        } else if (type === "spiral") {
          const turns=16;
          for(let i=0; i<totalWeeks; i++) {
             const t = i/(totalWeeks-1);
             const ang = t*Math.PI*2*turns - Math.PI/2;
             const r = 15 + t*145;
             els.push(<circle key={i} cx={cx+r*Math.cos(ang)} cy={cy+r*Math.sin(ang)} r={i===lived?3:1.4} fill={getColor(i)} />);
          }
        } else if (type === "constellation") {
           // Seeded random visual setup
           let seed = 42; const rnd = () => { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };
           for(let i=0; i<totalWeeks; i++) {
              const ang = rnd()*Math.PI*2;
              const r = Math.sqrt(rnd())*150;
              const isCurrent = i === lived;
              els.push(<circle key={i} cx={cx+r*Math.cos(ang)} cy={cy+r*Math.sin(ang)} r={isCurrent?3:rnd()>0.9?1.8:1} fill={getColor(i)} opacity={isCurrent?1:0.8} />);
           }
        }

        return (
          <div className="relative flex justify-center items-center">
             <svg viewBox={`0 0 ${W} ${H}`} className={`w-full h-auto max-w-[340px] ${type!=="constellation"?"svg-rotate":""}`}>
                <g>{els}</g>
             </svg>
             {/* AGE IN CENTER FOR RADIAL DESIGNS */}
             <div className={`absolute inset-0 flex flex-col items-center justify-center pointer-events-none ${colors.text}`}>
               <span className="text-4xl font-bold tracking-tighter">{stats.yearsLived}</span>
               <span className="text-[10px] uppercase tracking-widest opacity-60">Años</span>
             </div>
          </div>
        );
      }

      // 4. Snake
      if (type === "snake") {
         const cells = [];
         for(let r=0; r<80; r++){
           for(let c=0; c<52; c++){
             const idx = r%2===0 ? r*52+c : r*52+(51-c);
             cells.push(<div key={`${r}-${c}`} style={{backgroundColor:getColor(idx)}} className={`w-full pt-[100%] rounded-[0.5px] ${idx===lived?'animate-pulse z-10 scale-125':''}`}/>)
           }
         }
         return <div className="grid gap-[1px] wiggle max-w-[340px] mx-auto" style={{gridTemplateColumns:'repeat(52,1fr)'}}>{cells}</div>;
      }
      return null;
    });

    // --- MAIN APP ---
    function App() {
      const [users, setUsers] = useState(() => loadJSON(KEYS.users, {}));
      const [session, setSession] = useState(() => loadJSON(KEYS.session, null));
      const [flow, setFlow] = useState("loading");
      const [showSettings, setShowSettings] = useState(false);
      const [showMood, setShowMood] = useState(false);
      
      // Random content seed
      const [rndSeed, setRndSeed] = useState(0);

      const currentUser = session?.username ? users[session.username] : null;
      const lang = currentUser?.prefs?.lang || "es";
      const theme = currentUser?.prefs?.theme || "minimal";
      const design = currentUser?.prefs?.design || "grid";
      const t = (k) => I18N[lang]?.[k] ?? I18N.en?.[k] ?? k;
      const tc = THEMES[theme] || THEMES.minimal;
      
      const stats = useMemo(() => currentUser?.birthdate ? computeStats(currentUser.birthdate) : null, [currentUser]);

      // Generate randomized insights based on seed
      const insights = useMemo(() => {
        if(!stats) return {};
        // Simple seeded selection
        const pick = (pool) => {
           const arr = pool[lang] || pool.en;
           return arr[rndSeed % arr.length](stats);
        }
        return {
           societal: pick(INSIGHT_POOLS.societal),
           cosmic: pick(INSIGHT_POOLS.cosmic),
           nature: pick(INSIGHT_POOLS.nature)
        };
      }, [rndSeed, lang, stats]);

      useEffect(() => {
        // Init flow
        if (session?.username) {
           setFlow(users[session.username]?.birthdate ? "home" : "setBirthdate");
        } else {
           setFlow("welcome");
        }
        setRndSeed(Math.floor(Math.random() * 100)); // Rotate text on load
      }, []);

      useEffect(() => { saveJSON(KEYS.users, users); saveJSON(KEYS.session, session); }, [users, session]);

      const update = (patch) => {
        if(!currentUser) return;
        setUsers(prev => ({...prev, [session.username]: {...prev[session.username], ...patch}}));
      };

      // Auth & Forms
      const [inputUser, setInputUser] = useState("");
      const [inputPass, setInputPass] = useState("");
      const [dateVal, setDateVal] = useState("");
      
      const doAuth = (isReg) => {
         const u = inputUser.trim().toLowerCase(), p = inputPass;
         if(!u || !p) return;
         // Fake hash for demo
         const h = u+":"+p; 
         if(isReg) {
            if(users[u]) return alert("Existe");
            const nu = { username:u, pass:h, birthdate:"", prefs:{lang:"es",theme:"ocean",design:"spiral"}, moods:{} };
            setUsers(prev => ({...prev, [u]:nu}));
            setSession({username:u});
            setFlow("setBirthdate");
         } else {
            if(users[u] && users[u].pass === h) {
               setSession({username:u});
               setFlow(users[u].birthdate ? "home" : "setBirthdate");
            } else alert("Error");
         }
      };

      // Views
      if(flow === "welcome" || flow === "login" || flow === "register") {
         return (
           <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
             {/* Simple Mesh Background for Auth */}
             <div className="absolute inset-0 bg-slate-50 z-[-2]"></div>
             <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-blue-200 rounded-full blur-[100px] opacity-40 animate-pulse"></div>
             
             <div className="w-full max-w-sm glass p-8 rounded-3xl shadow-xl fade-in text-center">
                <h1 className="text-3xl font-black text-slate-900 mb-2 tracking-tight">{t("appTitle")}</h1>
                <p className="text-slate-500 mb-8">{t("onboardingSubtitle")}</p>
                
                {flow === "welcome" && (
                  <div className="space-y-3">
                    <button onClick={()=>setFlow("register")} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] transition-transform">{t("register")}</button>
                    <button onClick={()=>setFlow("login")} className="w-full py-4 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50">{t("login")}</button>
                  </div>
                )}
                
                {flow !== "welcome" && (
                  <div className="space-y-4 text-left">
                    <input className="w-full p-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-slate-900 transition-all" 
                           placeholder={t("username")} value={inputUser} onChange={e=>setInputUser(e.target.value)} />
                    <input className="w-full p-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-slate-900 transition-all" 
                           placeholder={t("password")} type="password" value={inputPass} onChange={e=>setInputPass(e.target.value)} />
                    <button onClick={()=>doAuth(flow==="register")} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-xl mt-4">
                      {flow==="register" ? t("register") : t("login")}
                    </button>
                    <button onClick={()=>setFlow("welcome")} className="w-full text-center text-sm text-slate-400 mt-2">{t("back")}</button>
                  </div>
                )}
             </div>
           </div>
         )
      }

      if(flow === "setBirthdate") {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
             <div className="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl fade-in">
               <h2 className="text-2xl font-bold mb-4">{t("setBirthdate")}</h2>
               <input type="date" className="w-full p-4 border rounded-xl mb-6 text-lg bg-slate-50" 
                      value={dateVal} onChange={e=>setDateVal(e.target.value)} />
               <button onClick={()=>{ if(dateVal) { update({birthdate:dateVal}); setFlow("home"); } }} 
                       disabled={!dateVal} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl disabled:opacity-50">
                 {t("done")}
               </button>
             </div>
          </div>
        )
      }

      // HOME
      if(stats) {
        // Condition to show Big Age in background for non-radial designs
        const isRadial = ["circle","spiral","constellation"].includes(design);
        
        return (
          <div className={`min-h-screen ${tc.text} relative overflow-hidden transition-colors duration-700`}>
            {/* BACKGROUND MESH */}
            <div className={`mesh-bg ${tc.bgClass}`}>
              <div className="mesh-blob blob-1" style={{'--blob-1':tc.blobs[0]}}></div>
              <div className="mesh-blob blob-2" style={{'--blob-2':tc.blobs[1]}}></div>
              <div className="mesh-blob blob-3" style={{'--blob-3':tc.blobs[2]}}></div>
            </div>

            {/* HEADER */}
            <div className="flex justify-between items-end px-6 pt-12 pb-4 max-w-lg mx-auto relative z-10">
               <div>
                 <h1 className="text-3xl font-black tracking-tight leading-none">{t("appTitle")}</h1>
                 <p className={`text-sm font-medium opacity-60 mt-1`}>{stats.percentageLived}% {t("lifeProgress")}</p>
               </div>
               <button onClick={()=>setShowSettings(true)} className="p-3 glass rounded-full hover:bg-black/5 transition-colors">
                 <Icon name="settings" />
               </button>
            </div>

            <div className="px-4 pb-24 max-w-lg mx-auto space-y-6 relative z-10">
              
              {/* VISUALIZER CARD */}
              <div className={`glass rounded-3xl p-6 relative border-0 shadow-sm overflow-hidden min-h-[380px] flex flex-col justify-between`}>
                 {/* Background Age for Linear Designs */}
                 {!isRadial && (
                    <div className="absolute top-4 right-6 text-[120px] font-black leading-none opacity-[0.04] select-none pointer-events-none">
                      {stats.yearsLived}
                    </div>
                 )}
                 
                 <div className="flex-1 flex items-center justify-center py-4">
                    <Visualizer type={design} stats={stats} colors={tc} />
                 </div>

                 <div className="flex justify-between items-end text-[10px] uppercase font-bold tracking-widest opacity-40">
                    <span>Nacimiento</span>
                    <span>{t("weeksLived")} {fmtInt(stats.weeksLived)}</span>
                 </div>
              </div>

              {/* STATS STRIP */}
              <div className="grid grid-cols-2 gap-3">
                 <div className="glass p-5 rounded-2xl">
                    <div className="text-xs uppercase font-bold opacity-50 mb-1">{t("weeksLeft")}</div>
                    <div className="text-2xl font-bold">{fmtInt(stats.weeksRemaining)}</div>
                 </div>
                 <div className="glass p-5 rounded-2xl">
                    <div className="text-xs uppercase font-bold opacity-50 mb-1">Días Vividos</div>
                    <div className="text-2xl font-bold">{fmtInt(stats.daysLived)}</div>
                 </div>
              </div>

              {/* DYNAMIC INSIGHTS */}
              <div>
                <Accordion title={t("societal")} tc={tc}>
                   <p className={`text-sm leading-relaxed opacity-80 py-2`}>{insights.societal}</p>
                </Accordion>
                <Accordion title={t("cosmic")} tc={tc}>
                   <p className={`text-sm leading-relaxed opacity-80 py-2`}>{insights.cosmic}</p>
                </Accordion>
                <Accordion title={t("nature")} tc={tc}>
                   <p className={`text-sm leading-relaxed opacity-80 py-2`}>{insights.nature}</p>
                </Accordion>
              </div>

              {/* MOOD */}
              <div className="glass p-6 rounded-3xl">
                <div className="flex justify-between items-center mb-4">
                  <span className="font-bold">{t("mood")}</span>
                  <button onClick={()=>setShowMood(true)} className={`text-xs font-bold px-3 py-1.5 rounded-full bg-black/5 hover:bg-black/10 transition-colors`}>
                    + {t("moodLogNow")}
                  </button>
                </div>
                <div className="flex gap-0.5 justify-end flex-wrap h-8 overflow-hidden">
                   {/* Mini heatmap */}
                   {Array.from({length:60}).map((_,i)=>{
                      // Fake logic for demo visualization
                      return <div key={i} className="w-1.5 h-full rounded-sm opacity-20 bg-current"></div>
                   })}
                </div>
              </div>
            </div>

            {/* MODALS */}
            {showSettings && (
               <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-md flex justify-end">
                  <div className={`w-full max-w-sm h-full ${tc.bgClass} shadow-2xl p-6 overflow-y-auto fade-in`}>
                     <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-bold">{t("settings")}</h2>
                        <button onClick={()=>setShowSettings(false)}><Icon name="x"/></button>
                     </div>
                     
                     <h3 className="text-xs font-bold uppercase opacity-50 mb-3">{t("language")}</h3>
                     <div className="flex gap-2 mb-8">
                        {['es','en'].map(l => (
                          <button key={l} onClick={()=>update({prefs:{...currentUser.prefs, lang:l}})} className={`flex-1 py-3 rounded-xl border font-bold ${lang===l?tc.hex.accent+' text-white border-transparent':'border-slate-200'}`}>{l.toUpperCase()}</button>
                        ))}
                     </div>

                     <h3 className="text-xs font-bold uppercase opacity-50 mb-3">{t("theme")}</h3>
                     <div className="grid grid-cols-2 gap-2 mb-8">
                        {Object.keys(THEMES).map(k => (
                          <button key={k} onClick={()=>update({prefs:{...currentUser.prefs, theme:k}})} 
                             className={`py-3 rounded-xl border text-sm font-medium ${theme===k?'ring-2 ring-blue-500 border-transparent':''}`}
                             style={{backgroundColor: THEMES[k].hex.future, color: THEMES[k].hex.text}}>
                             {THEMES[k].label[lang]}
                          </button>
                        ))}
                     </div>

                     <h3 className="text-xs font-bold uppercase opacity-50 mb-3">{t("design")}</h3>
                     <div className="grid grid-cols-2 gap-2 mb-8">
                        {["grid","circle","spiral","wave","snake","constellation"].map(d => (
                          <button key={d} onClick={()=>update({prefs:{...currentUser.prefs, design:d}})} 
                             className={`py-3 rounded-xl border text-sm capitalize ${design===d?'bg-slate-900 text-white border-transparent':''}`}>
                             {d}
                          </button>
                        ))}
                     </div>

                     <button onClick={()=>{setSession(null); setFlow("welcome"); setShowSettings(false);}} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-xl">{t("close")} sesión</button>
                  </div>
               </div>
            )}
            
            {showMood && (
              <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={()=>setShowMood(false)}>
                 <div className="bg-white p-6 rounded-3xl w-full max-w-xs shadow-2xl fade-in" onClick={e=>e.stopPropagation()}>
                    <h3 className="text-lg font-bold mb-4 text-center text-slate-900">{t("moodTodayTitle")}</h3>
                    <div className="grid grid-cols-2 gap-2">
                       {MOODS.map(m => (
                          <button key={m.id} onClick={()=>{setShowMood(false);}} 
                             className="p-3 rounded-xl bg-slate-50 hover:bg-slate-100 flex items-center gap-2 text-sm text-slate-700 font-medium">
                             <div className="w-3 h-3 rounded-full" style={{background:m.color}}/> {m.label[lang]||m.label.en}
                          </button>
                       ))}
                    </div>
                 </div>
              </div>
            )}
          </div>
        );
      }
      return <div/>;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
