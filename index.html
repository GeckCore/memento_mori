<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Tu Vida en Semanas</title>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    button, summary { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }

    html, body { height: 100%; }
    body { margin: 0; overflow-x: hidden; min-height: 100dvh; background: white; }
    #root { min-height: 100dvh; }

    .safe-bottom { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
    .safe-top { padding-top: calc(0.5rem + env(safe-area-inset-top)); }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

    .fade-in { animation: fadeIn .25s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
    summary::-webkit-details-marker { display: none; }

    /* Animaciones suaves (mobile-friendly) */
    @keyframes floaty { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-6px);} }
    @keyframes breathe { 0%,100% { transform: scale(1);} 50% { transform: scale(1.015);} }
    @keyframes rotateSlow { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    @keyframes twinkle { 0%,100% { opacity: .55;} 50% { opacity: 1;} }
    @keyframes wiggle { 0%,100% { transform: rotate(-0.7deg);} 50% { transform: rotate(0.7deg);} }

    .design-shell { animation: floaty 7s ease-in-out infinite; }
    .design-shell-inner { animation: breathe 8s ease-in-out infinite; }

    .svg-rotate { transform-origin: center; transform-box: fill-box; animation: rotateSlow 26s linear infinite; }
    .twinkle { animation: twinkle 2.8s ease-in-out infinite; }
    .wiggle { animation: wiggle 6s ease-in-out infinite; }

    @media (prefers-reduced-motion: reduce) {
      .design-shell, .design-shell-inner, .svg-rotate, .twinkle, .wiggle { animation: none !important; }
      .animate-pulse { animation: none !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ================== SAFE STORAGE ==================
    const KEYS = { session: "wol_session_v3", users: "wol_users_v3" };
    const safeGet = (k) => { try { return localStorage.getItem(k); } catch { return null; } };
    const safeSet = (k, v) => { try { localStorage.setItem(k, v); } catch {} };
    const safeDel = (k) => { try { localStorage.removeItem(k); } catch {} };
    const loadJSON = (k, fb) => {
      const r = safeGet(k);
      if (!r) return fb;
      try { return JSON.parse(r); } catch { return fb; }
    };
    const saveJSON = (k, o) => safeSet(k, JSON.stringify(o));

    // ================== ICONS ==================
    const SettingsIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
      </svg>
    );
    const XIcon = () => (
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    const ChevronIcon = ({ open }) => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true"
        style={{ transform: open ? "rotate(180deg)" : "rotate(0deg)", transition: "transform .15s ease" }}>
        <path d="M6 9l6 6 6-6"></path>
      </svg>
    );
    const PartyIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <path d="M8 21s8-2 12-12c0 0-8 2-12 12z"></path>
        <path d="M3 7l6 2-2-6-4 4z"></path>
      </svg>
    );

    // ================== HELPERS ==================
    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
    const fmtInt = (n) => Math.round(n).toLocaleString(undefined);

    function parseISODateToLocalMidnight(iso) {
      const parts = (iso || "").split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]), m = Number(parts[1]), d = Number(parts[2]);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m - 1, d, 0, 0, 0, 0);
      if (Number.isNaN(dt.getTime())) return null;
      return dt;
    }
    function isoToday() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function isBirthdayToday(birthISO) {
      const b = parseISODateToLocalMidnight(birthISO);
      if (!b) return false;
      const now = new Date();
      return (b.getMonth() === now.getMonth()) && (b.getDate() === now.getDate());
    }

    // ================== SEEDED RNG (daily stable) ==================
    function hashToUint(str) {
      let h = 2166136261 >>> 0;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }
    function makeRng(seed) {
      let x = seed >>> 0;
      return () => {
        x ^= x << 13; x >>>= 0;
        x ^= x >>> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x >>> 0) / 4294967296;
      };
    }
    function pickNUnique(arr, n, rng) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, Math.min(n, a.length));
    }

    // ================== CRYPTO (password) ==================
    async function sha256Hex(text) {
      if (crypto?.subtle?.digest) {
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      return String(hashToUint(text));
    }
    async function passwordHash(username, password) {
      return await sha256Hex("wol:v3:" + username + ":" + password);
    }

    // ================== THEMES ==================
    const THEMES = {
      minimal: { label:{es:"Minimal",en:"Minimal"}, bg:"bg-white", text:"text-gray-900", textSecondary:"text-gray-600", card:"bg-gray-50", border:"border-gray-200", accent:"bg-gray-900", accentHover:"hover:bg-gray-800", track:"bg-gray-200",
        hex:{ text:"#111827", textSecondary:"#4b5563", weekPast:"#111827", weekFuture:"#e5e7eb", weekCurrent:"#3b82f6", accent:"#111827", track:"#e5e7eb" } },
      dark: { label:{es:"Oscuro",en:"Dark"}, bg:"bg-gray-950", text:"text-gray-100", textSecondary:"text-gray-400", card:"bg-gray-900", border:"border-gray-800", accent:"bg-purple-600", accentHover:"hover:bg-purple-700", track:"bg-gray-800",
        hex:{ text:"#f3f4f6", textSecondary:"#9ca3af", weekPast:"#a855f7", weekFuture:"#1f2937", weekCurrent:"#06b6d4", accent:"#7c3aed", track:"#1f2937" } },
      warm: { label:{es:"Cálido",en:"Warm"}, bg:"bg-amber-50", text:"text-amber-950", textSecondary:"text-amber-700", card:"bg-amber-100", border:"border-amber-300", accent:"bg-orange-600", accentHover:"hover:bg-orange-700", track:"bg-amber-200",
        hex:{ text:"#451a03", textSecondary:"#b45309", weekPast:"#ea580c", weekFuture:"#fde68a", weekCurrent:"#ef4444", accent:"#ea580c", track:"#fde68a" } },
      ocean: { label:{es:"Océano",en:"Ocean"}, bg:"bg-sky-50", text:"text-slate-900", textSecondary:"text-slate-600", card:"bg-sky-100", border:"border-sky-300", accent:"bg-blue-600", accentHover:"hover:bg-blue-700", track:"bg-sky-200",
        hex:{ text:"#0f172a", textSecondary:"#475569", weekPast:"#2563eb", weekFuture:"#bae6fd", weekCurrent:"#14b8a6", accent:"#2563eb", track:"#bae6fd" } },
      forest: { label:{es:"Bosque",en:"Forest"}, bg:"bg-emerald-50", text:"text-emerald-950", textSecondary:"text-emerald-700", card:"bg-emerald-100", border:"border-emerald-300", accent:"bg-emerald-700", accentHover:"hover:bg-emerald-800", track:"bg-emerald-200",
        hex:{ text:"#064e3b", textSecondary:"#047857", weekPast:"#047857", weekFuture:"#a7f3d0", weekCurrent:"#22c55e", accent:"#047857", track:"#a7f3d0" } },
      rose: { label:{es:"Rosa",en:"Rose"}, bg:"bg-rose-50", text:"text-rose-950", textSecondary:"text-rose-700", card:"bg-rose-100", border:"border-rose-300", accent:"bg-rose-600", accentHover:"hover:bg-rose-700", track:"bg-rose-200",
        hex:{ text:"#4c0519", textSecondary:"#be123c", weekPast:"#be123c", weekFuture:"#fecdd3", weekCurrent:"#fb7185", accent:"#e11d48", track:"#fecdd3" } },
      neon: { label:{es:"Neón",en:"Neon"}, bg:"bg-black", text:"text-white", textSecondary:"text-zinc-300", card:"bg-zinc-900", border:"border-zinc-800", accent:"bg-fuchsia-600", accentHover:"hover:bg-fuchsia-700", track:"bg-zinc-800",
        hex:{ text:"#ffffff", textSecondary:"#d4d4d8", weekPast:"#d946ef", weekFuture:"#27272a", weekCurrent:"#22c55e", accent:"#d946ef", track:"#27272a" } },
      slate: { label:{es:"Grafito",en:"Slate"}, bg:"bg-slate-50", text:"text-slate-950", textSecondary:"text-slate-600", card:"bg-slate-100", border:"border-slate-300", accent:"bg-slate-800", accentHover:"hover:bg-slate-900", track:"bg-slate-200",
        hex:{ text:"#0f172a", textSecondary:"#475569", weekPast:"#334155", weekFuture:"#cbd5e1", weekCurrent:"#0ea5e9", accent:"#1f2937", track:"#cbd5e1" } },
    };

    // ================== I18N ==================
    const I18N = {
      es: {
        appTitle:"Tu vida en semanas",
        appSubtitle:"Visualiza tu tiempo (80 años = 4160 semanas)",
        settings:"Ajustes", close:"Cerrar",
        language:"Idioma", spanish:"Español", english:"Inglés",
        theme:"Tema", design:"Diseño",
        register:"Registrarme", login:"Iniciar sesión",
        username:"Usuario", password:"Contraseña",
        logout:"Cerrar sesión",
        exportData:"Exportar datos", importData:"Importar",
        exportHintTitle:"Llevar tu perfil a otro dispositivo",
        exportHintBody:"Ajustes → abajo → Exportar datos. Copia el código y pégalo en el otro móvil en Importar.",
        copy:"Copiar", copied:"Copiado",
        whenBorn:"¿Cuándo naciste?", setBirthdate:"Vamos a guardar tu fecha de nacimiento", done:"Listo",
        chooseAuth:"¿Qué quieres hacer?", alreadyHave:"Ya tengo cuenta", createNew:"Crear cuenta",
        invalidFuture:"La fecha no puede ser en el futuro.",
        yourLife:"Tu vida",
        weeksLived:"Semanas vividas", daysLived:"Días vividos",
        lifeProgress:"Progreso", weeksLeft:"Te quedan aprox.", weeks:"semanas",
        moodTodayTitle:"¿Cómo estás hoy?", moodTodaySubtitle:"Un toque y queda guardado.", skip:"Omitir",
        mood:"Estado de ánimo", history90:"Historial (90 días)", moodLogNow:"Registrar ánimo ahora",
        highlights:"Life highlights",
        societal:"Contexto social", cosmic:"Perspectiva cósmica", nature:"Mundo natural",
        optionalNumbers:"Datos numéricos (opcional)",
        save:"Guardar",
        birthdayTitle:"¡Feliz cumpleaños!", birthdayDismiss:"Ver luego", birthdayOpen:"Leer carta", birthdayLetter:"Carta",
        errorTitle:"Algo falló",
        errorBody:"La app detectó un error. Puedes reiniciar los datos locales y volver a abrir.",
        reset:"Resetear datos"
      },
      en: {
        appTitle:"Your life in weeks",
        appSubtitle:"Visualize your time (80 years = 4,160 weeks)",
        settings:"Settings", close:"Close",
        language:"Language", spanish:"Spanish", english:"English",
        theme:"Theme", design:"Design",
        register:"Sign up", login:"Log in",
        username:"Username", password:"Password",
        logout:"Log out",
        exportData:"Export data", importData:"Import",
        exportHintTitle:"Move your profile to another device",
        exportHintBody:"Settings → bottom → Export data. Copy the code and paste it on the other phone using Import.",
        copy:"Copy", copied:"Copied",
        whenBorn:"When were you born?", setBirthdate:"Let’s save your birthdate", done:"Done",
        chooseAuth:"What do you want to do?", alreadyHave:"I already have an account", createNew:"Create an account",
        invalidFuture:"Birthdate cannot be in the future.",
        yourLife:"Your life",
        weeksLived:"Weeks lived", daysLived:"Days lived",
        lifeProgress:"Progress", weeksLeft:"You have approx.", weeks:"weeks left",
        moodTodayTitle:"How are you today?", moodTodaySubtitle:"Tap once and it’s saved.", skip:"Skip",
        mood:"Mood", history90:"History (90 days)", moodLogNow:"Log mood now",
        highlights:"Life highlights",
        societal:"Societal context", cosmic:"Cosmic perspective", nature:"Natural world",
        optionalNumbers:"Numeric context (optional)",
        save:"Save",
        birthdayTitle:"Happy Birthday!", birthdayDismiss:"Later", birthdayOpen:"Read letter", birthdayLetter:"Letter",
        errorTitle:"Something broke",
        errorBody:"The app detected an error. You can reset local data and reopen.",
        reset:"Reset data"
      }
    };

    // ================== MOODS ==================
    const MOODS = [
      { id:"happy",    label:{es:"Contento", en:"Happy"},       color:"#22c55e", kind:"pos" },
      { id:"calm",     label:{es:"Calmado", en:"Calm"},         color:"#06b6d4", kind:"pos" },
      { id:"focused",  label:{es:"Enfocado", en:"Focused"},     color:"#3b82f6", kind:"pos" },
      { id:"grateful", label:{es:"Agradecido", en:"Grateful"},  color:"#eab308", kind:"pos" },
      { id:"tired",    label:{es:"Cansado", en:"Tired"},        color:"#a3a3a3", kind:"neg" },
      { id:"sad",      label:{es:"Triste", en:"Sad"},           color:"#6366f1", kind:"neg" },
      { id:"angry",    label:{es:"Enfadado", en:"Angry"},       color:"#ef4444", kind:"neg" },
      { id:"anxious",  label:{es:"Ansioso", en:"Anxious"},      color:"#f59e0b", kind:"neg" },
    ];
    const moodById = (id) => MOODS.find(m => m.id === id) || null;

    // ================== DEFAULT CONTEXT ==================
    const DEFAULT_CONTEXT = {
      populationAtBirth: 6900000000,
      populationNow: 8100000000,
      birthsPerYear: 140000000,
      deathsPerYear: 60000000,
    };

    // ================== STATS ==================
    function computeStats(birthISO, context) {
      const birth = parseISODateToLocalMidnight(birthISO);
      if (!birth) return null;
      const now = new Date();
      if (birth.getTime() > now.getTime()) return { invalid:true, messageKey:"invalidFuture" };

      const msDay = 86400000;
      const msWeek = msDay * 7;
      const diffMs = now.getTime() - birth.getTime();

      const daysLived = Math.floor(diffMs / msDay);
      const weeksLived = Math.floor(diffMs / msWeek);

      const totalWeeks = 4160;
      const weeksLivedClamped = clamp(weeksLived, 0, totalWeeks);
      const weeksRemaining = Math.max(0, totalWeeks - weeksLivedClamped);
      const pct = clamp(Math.round((weeksLivedClamped / totalWeeks) * 100), 0, 100);

      const yearsLived = Math.floor(daysLived / 365.2425);
      const monthsLived = Math.floor((daysLived % 365.2425) / 30.436875);

      const minutesLived = Math.floor(diffMs / 60000);
      const heartBeats = minutesLived * 72;
      const breaths = minutesLived * 16;
      const sleepHours = daysLived * 8;

      const seasons = Math.floor(daysLived / (365.2425 / 4));
      const lunarCycles = Math.floor(daysLived / 29.53059);
      const tripsAroundSun = Math.floor(daysLived / 365.2425);

      const AU_KM = 149_597_870.7;
      const earthOrbitKmPerYear = 2 * Math.PI * AU_KM;
      const earthAroundSunKm = (daysLived / 365.2425) * earthOrbitKmPerYear;

      const secondsLived = Math.floor(diffMs / 1000);
      const solarSystemKm = secondsLived * 220;

      const universeAgeYears = 13_800_000_000;
      const lifespanPercentOfUniverse = ((daysLived / 365.2425) / universeAgeYears) * 100;

      const years = daysLived / 365.2425;
      const births = years * Number(context.birthsPerYear || 0);
      const deaths = years * Number(context.deathsPerYear || 0);

      return {
        invalid:false,
        totalWeeks,
        weeksLived, weeksLivedClamped, weeksRemaining,
        percentageLived: pct,
        daysLived, yearsLived, monthsLived,
        heartBeats, breaths, sleepHours, seasons,
        lunarCycles, tripsAroundSun,
        earthAroundSunKm, solarSystemKm, lifespanPercentOfUniverse,
        estBirths: births, estDeaths: deaths
      };
    }

    // ================== INSIGHTS (rotate daily) ==================
    function buildInsightPools(lang, stats, context) {
      const popStart = Number(context.populationAtBirth || 0);
      const popNow = Number(context.populationNow || 0);

      const social = [
        () => (lang==="es")
          ? `Durante tu vida, la población mundial pasó de ~${fmtInt(popStart)} a ~${fmtInt(popNow)}.`
          : `During your lifetime, world population moved from ~${fmtInt(popStart)} to ~${fmtInt(popNow)}.`,
        () => (lang==="es")
          ? `Desde tu nacimiento, el mundo vivió ~${fmtInt(stats.estBirths)} nacimientos y ~${fmtInt(stats.estDeaths)} muertes (estimación).`
          : `Since your birth: ~${fmtInt(stats.estBirths)} births and ~${fmtInt(stats.estDeaths)} deaths (estimate).`,
        () => (lang==="es") ? `Tu tiempo es finito. Por eso importa.` : `Your time is finite. That’s why it matters.`,
        () => (lang==="es") ? `Una semana buena se gana por repetición.` : `A good week is won by repetition.`,
      ];

      const cosmic = [
        () => (lang==="es")
          ? `Desde que naciste, la Tierra recorrió ~${fmtInt(stats.earthAroundSunKm)} km alrededor del Sol.`
          : `Since your birth, Earth traveled ~${fmtInt(stats.earthAroundSunKm)} km around the Sun.`,
        () => (lang==="es")
          ? `En ese tiempo, el Sistema Solar avanzó ~${fmtInt(stats.solarSystemKm)} km en la galaxia (aprox.).`
          : `In that time, the Solar System moved ~${fmtInt(stats.solarSystemKm)} km through the galaxy (approx.).`,
        () => (lang==="es")
          ? `Tu vida es ~${stats.lifespanPercentOfUniverse.toExponential(3)}% de la edad del universo (aprox.).`
          : `Your life is ~${stats.lifespanPercentOfUniverse.toExponential(3)}% of the universe’s age (approx.).`,
      ];

      const nature = [
        () => (lang==="es")
          ? `Has vivido ~${fmtInt(stats.lunarCycles)} ciclos lunares y ~${fmtInt(stats.tripsAroundSun)} vueltas al Sol.`
          : `You’ve lived ~${fmtInt(stats.lunarCycles)} lunar cycles and ~${fmtInt(stats.tripsAroundSun)} trips around the Sun.`,
        () => (lang==="es")
          ? `Dormiste ~${fmtInt(stats.sleepHours)} horas. Tu cuerpo te sostuvo miles de días.`
          : `You slept ~${fmtInt(stats.sleepHours)} hours. Your body carried you for thousands of days.`,
        () => (lang==="es")
          ? `El cambio es normal: tus células se han renovado varias veces.`
          : `Change is normal: your cells have renewed multiple times.`,
      ];

      return { social, cosmic, nature };
    }

    function introPool(lang) {
      return (lang === "es")
        ? [
            ["Preciso. Simple. Real.", "Una semana a la vez."],
            ["No es presión, es claridad.", "Hoy cuenta."],
            ["Perspectiva útil.", "Tu tiempo se puede ver."],
          ]
        : [
            ["Precise. Simple. Real.", "One week at a time."],
            ["Not pressure—clarity.", "Today matters."],
            ["Useful perspective.", "You can see your time."],
          ];
    }

    function lifeHighlightsLines(lang, stats) {
      const weeks = stats.weeksLived;
      const pct = stats.percentageLived;
      const days = stats.daysLived;
      const seasons = stats.seasons;
      const heart = stats.heartBeats;
      const breaths = stats.breaths;
      const sleepH = stats.sleepHours;

      if (lang === "en") {
        return [
          `You've lived ${fmtInt(weeks)} weeks, which is ${pct}% of a full life.`,
          `That's ${fmtInt(days)} days of experience and approximately ${fmtInt(seasons)} seasons observed.`,
          `Your heart has beaten approximately ${fmtInt(heart)} times.`,
          `You've taken around ${fmtInt(breaths)} breaths and slept about ${fmtInt(sleepH)} hours.`,
        ];
      }
      return [
        `Has vivido ${fmtInt(weeks)} semanas, lo que es un ${pct}% de una vida completa.`,
        `Eso son ${fmtInt(days)} días de experiencia y aproximadamente ${fmtInt(seasons)} estaciones observadas.`,
        `Tu corazón ha latido aproximadamente ${fmtInt(heart)} veces.`,
        `Has respirado alrededor de ${fmtInt(breaths)} veces y dormido unas ${fmtInt(sleepH)} horas.`,
      ];
    }

    // ================== EXPORT/IMPORT ==================
    function unicodeB64Encode(obj) {
      return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    }
    function unicodeB64Decode(str) {
      return JSON.parse(decodeURIComponent(escape(atob(str))));
    }

    // ================== UI ==================
    function Modal({ open, onClose, children }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-3">
          <div className="w-full max-w-md rounded-2xl border border-black/10 bg-white/90 glass p-4 fade-in">
            <div className="flex justify-end">
              <button onClick={onClose} aria-label="close" className="text-gray-600">
                <XIcon />
              </button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    function Accordion({ title, children, defaultOpen=false, themeColors }) {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl mb-3 overflow-hidden`}>
          <button onClick={() => setOpen(o => !o)} className="w-full px-4 py-3 flex items-center justify-between">
            <span className="font-semibold">{title}</span>
            <ChevronIcon open={open} />
          </button>
          {open && <div className="px-4 pb-4">{children}</div>}
        </div>
      );
    }

    function PillButton({ label, color, onClick }) {
      return (
        <button onClick={onClick} className="p-3 rounded-xl border border-black/10 flex items-center gap-2 bg-white/60">
          <span className="inline-block w-3 h-3 rounded-sm" style={{ backgroundColor: color }}></span>
          <span>{label}</span>
        </button>
      );
    }

    // ================== ERROR BOUNDARY ==================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      componentDidCatch(error, info) {
        // no-op (could log)
      }
      render() {
        if (this.state.hasError) return this.props.fallback(this.state.error);
        return this.props.children;
      }
    }

    // ================== APP ==================
    function App() {
      const [users, setUsers] = useState(() => loadJSON(KEYS.users, {}));
      const [session, setSession] = useState(() => loadJSON(KEYS.session, null)); // { username }
      const currentUser = session?.username ? users[session.username] : null;

      const [flow, setFlow] = useState(() => {
        if (!session?.username) return "welcome";
        const u = users[session.username];
        if (!u?.birthdate) return "setBirthdate";
        return "home";
      });

      const [authUser, setAuthUser] = useState("");
      const [authPass, setAuthPass] = useState("");
      const [authMsg, setAuthMsg] = useState("");

      const [lang, setLang] = useState(currentUser?.prefs?.lang || "es");
      const [theme, setTheme] = useState(currentUser?.prefs?.theme || "minimal");
      const [design, setDesign] = useState(currentUser?.prefs?.design || "grid");
      const [birthdate, setBirthdate] = useState(currentUser?.birthdate || "");
      const [context, setContext] = useState(currentUser?.context || DEFAULT_CONTEXT);

      const [showSettings, setShowSettings] = useState(false);
      const [tempBirthdate, setTempBirthdate] = useState("");
      const [dateError, setDateError] = useState("");

      const [showMoodModal, setShowMoodModal] = useState(false);

      const [exportCode, setExportCode] = useState("");
      const [importCode, setImportCode] = useState("");
      const [copyState, setCopyState] = useState("idle");
      const [importMsg, setImportMsg] = useState("");

      const [showBirthdayCard, setShowBirthdayCard] = useState(false);
      const [showBirthdayModal, setShowBirthdayModal] = useState(false);

      const themeColors = useMemo(() => THEMES[theme] || THEMES.minimal, [theme]);
      const t = (k) => I18N[lang]?.[k] ?? I18N.en?.[k] ?? k;

      useEffect(() => saveJSON(KEYS.users, users), [users]);
      useEffect(() => saveJSON(KEYS.session, session), [session]);

      // refresh local state when session changes
      useEffect(() => {
        const u = session?.username ? users[session.username] : null;
        if (!u) return;
        setLang(u.prefs?.lang || "es");
        setTheme(u.prefs?.theme || "minimal");
        setDesign(u.prefs?.design || "grid");
        setBirthdate(u.birthdate || "");
        setContext(u.context || DEFAULT_CONTEXT);
        setFlow(u.birthdate ? "home" : "setBirthdate");
      }, [session?.username]);

      function updateCurrentUser(patch) {
        if (!session?.username) return;
        setUsers(prev => {
          const copy = { ...prev };
          const base = copy[session.username] || {};
          copy[session.username] = { ...base, ...patch };
          return copy;
        });
      }
      function updatePrefs(patch) {
        updateCurrentUser({ prefs: { ...(currentUser?.prefs || {}), ...patch } });
      }
      useEffect(() => { if (currentUser) updatePrefs({ lang }); }, [lang]);
      useEffect(() => { if (currentUser) updatePrefs({ theme }); }, [theme]);
      useEffect(() => { if (currentUser) updatePrefs({ design }); }, [design]);

      const stats = useMemo(() => {
        if (!birthdate) return null;
        return computeStats(birthdate, context);
      }, [birthdate, context]);

      // daily insight selection
      const dailyInsights = useMemo(() => {
        if (!currentUser || !stats || stats.invalid) return null;
        const seed = hashToUint(currentUser.username + "|" + isoToday() + "|" + design + "|" + theme + "|" + lang);
        const rng = makeRng(seed);
        const pools = buildInsightPools(lang, stats, context);

        const intro = pickNUnique(introPool(lang), 1, rng)[0] || ["", ""];
        const social = pickNUnique(pools.social, 3, rng).map(fn => fn());
        const cosmic = pickNUnique(pools.cosmic, 3, rng).map(fn => fn());
        const nature = pickNUnique(pools.nature, 3, rng).map(fn => fn());
        return { intro, social, cosmic, nature };
      }, [currentUser?.username, stats, context, design, theme, lang]);

      // prompt mood once per day
      useEffect(() => {
        if (!currentUser || !birthdate) return;
        const today = isoToday();
        const moods = currentUser.moods || {};
        if (!moods[today]) setShowMoodModal(true);
      }, [currentUser?.username, birthdate]);

      // birthday card (once per day)
      useEffect(() => {
        if (!currentUser || !birthdate) return;
        if (!isBirthdayToday(birthdate)) { setShowBirthdayCard(false); return; }
        const today = isoToday();
        if (currentUser.birthdayShownISO === today) { setShowBirthdayCard(false); return; }
        setShowBirthdayCard(true);
      }, [currentUser?.username, birthdate]);

      function dismissBirthdayCard() {
        setShowBirthdayCard(false);
        updateCurrentUser({ birthdayShownISO: isoToday() });
      }

      async function doRegister() {
        setAuthMsg("");
        const u = authUser.trim();
        const p = authPass;
        if (!u || !p) return;
        if (users[u]) { setAuthMsg(lang === "es" ? "Ese usuario ya existe." : "That username already exists."); return; }
        const passHash = await passwordHash(u, p);
        const newUser = {
          version: 3,
          username: u,
          passHash,
          createdAt: Date.now(),
          birthdate: "",
          prefs: { lang: "es", theme: "minimal", design: "grid" },
          moods: {},
          context: { ...DEFAULT_CONTEXT },
          birthdayShownISO: null
        };
        setUsers(prev => ({ ...prev, [u]: newUser }));
        setSession({ username: u });
        setAuthUser(""); setAuthPass(""); setAuthMsg("");
        setFlow("setBirthdate");
      }

      async function doLogin() {
        setAuthMsg("");
        const u = authUser.trim();
        const p = authPass;
        if (!u || !p) return;
        const rec = users[u];
        if (!rec) { setAuthMsg(lang === "es" ? "Usuario o contraseña incorrectos." : "Wrong username or password."); return; }
        const passHash = await passwordHash(u, p);
        if (passHash !== rec.passHash) { setAuthMsg(lang === "es" ? "Usuario o contraseña incorrectos." : "Wrong username or password."); return; }
        setSession({ username: u });
        setAuthUser(""); setAuthPass(""); setAuthMsg("");
        setFlow(rec.birthdate ? "home" : "setBirthdate");
      }

      function logout() {
        setSession(null);
        setShowSettings(false);
        setExportCode("");
        setImportCode("");
        setImportMsg("");
        setFlow("welcome");
      }

      function saveBirthdate() {
        setDateError("");
        if (!tempBirthdate) return;
        const s = computeStats(tempBirthdate, context);
        if (!s || s.invalid) { setDateError(t(s?.messageKey || "invalidFuture")); return; }
        setBirthdate(tempBirthdate);
        updateCurrentUser({ birthdate: tempBirthdate });
        setTempBirthdate("");
        setFlow("home");
      }

      function saveMood(moodId) {
        if (!currentUser) return;
        const today = isoToday();
        const newMoods = { ...(currentUser.moods || {}), [today]: moodId };
        updateCurrentUser({ moods: newMoods });
        setShowMoodModal(false);
      }

      function moodHistory(lastDays=90) {
        const out = [];
        const moods = currentUser?.moods || {};
        const now = new Date();
        for (let i = lastDays - 1; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          const iso = `${y}-${m}-${day}`;
          out.push({ iso, id: moods[iso] || null });
        }
        return out;
      }

      function doExport() {
        if (!currentUser) return;
        const payload = { app:"weeks-of-life", version:3, exportedAt:Date.now(), user: currentUser };
        try {
          setExportCode(unicodeB64Encode(payload));
          setCopyState("idle");
        } catch {
          setExportCode("");
        }
      }

      async function copyExport() {
        if (!exportCode) return;
        try {
          await navigator.clipboard.writeText(exportCode);
          setCopyState("copied");
          setTimeout(() => setCopyState("idle"), 1200);
        } catch {
          setCopyState("copied");
          setTimeout(() => setCopyState("idle"), 1200);
        }
      }

      function doImport() {
        setImportMsg("");
        try {
          const payload = unicodeB64Decode(importCode.trim());
          if (!payload || payload.app !== "weeks-of-life" || !payload.user?.username) throw new Error("bad");
          const u = payload.user.username;
          setUsers(prev => ({ ...prev, [u]: payload.user }));
          setImportMsg(lang === "es" ? "Perfil importado. Ahora inicia sesión con tu usuario/contraseña." : "Profile imported. Now log in with your username/password.");
          setImportCode("");
        } catch {
          setImportMsg(lang === "es" ? "Código inválido." : "Invalid code.");
        }
      }

      // ================== DESIGNS (memoized) ==================
      const designNode = useMemo(() => {
        if (!stats || stats.invalid || !currentUser) return null;

        const weekColorFor = (i) => {
          const wl = stats.weeksLivedClamped ?? 0;
          if (i < wl) return themeColors.hex.weekPast;
          if (i === wl) return themeColors.hex.weekCurrent;
          return themeColors.hex.weekFuture;
        };

        const WEEKS = 4160;
        const weeksPerRow = 52;

        const renderGrid = () => {
          const cells = [];
          for (let i = 0; i < WEEKS; i++) {
            const isCurrent = i === stats.weeksLivedClamped;
            cells.push(
              <div key={i}
                className={"w-2 h-2 rounded-sm " + (isCurrent ? "animate-pulse" : "")}
                style={{ backgroundColor: weekColorFor(i) }} />
            );
          }
          return (
            <div className="grid gap-[2px] justify-center"
                 style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 0.5rem))` }}>
              {cells}
            </div>
          );
        };

        const renderSnake = () => {
          const cells = [];
          for (let row=0; row<80; row++) {
            for (let col=0; col<52; col++) {
              const idx = row%2===0 ? (row*52 + col) : (row*52 + (51-col));
              const isCurrent = idx === stats.weeksLivedClamped;
              cells.push(
                <div key={row+"-"+col}
                  className={"w-2 h-2 rounded-sm " + (isCurrent ? "animate-pulse" : "")}
                  style={{ backgroundColor: weekColorFor(idx) }} />
              );
            }
          }
          return (
            <div className="wiggle">
              <div className="grid gap-[2px] justify-center"
                   style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 0.5rem))` }}>
                {cells}
              </div>
            </div>
          );
        };

        const renderWave = () => {
          const bars = [];
          for (let i = 0; i < WEEKS; i++) {
            const col = i % weeksPerRow;
            const base = 6, amp = 10;
            const h = base + Math.round((Math.sin(col * 0.35) + 1) * 0.5 * amp);
            const isCurrent = i === stats.weeksLivedClamped;
            bars.push(
              <div key={i}
                className={"w-[6px] rounded-t " + (isCurrent ? "animate-pulse" : "")}
                style={{ height: `${h}px`, backgroundColor: weekColorFor(i) }} />
            );
          }
          return (
            <div className="grid gap-[2px] justify-center items-end"
                 style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 6px))` }}>
              {bars}
            </div>
          );
        };

        const renderCircle = () => {
          const W=340,H=340, cx=W/2, cy=H/2;
          const rings=80, perRing=52, maxR=150, minR=35, step=(maxR-minR)/(rings-1);
          const dots = [];
          for (let year=0; year<rings; year++) {
            const r = minR + step*year;
            for (let w=0; w<perRing; w++) {
              const idx = year*perRing + w;
              const ang = (w/perRing)*Math.PI*2 - Math.PI/2;
              const x = cx + r*Math.cos(ang);
              const y = cy + r*Math.sin(ang);
              const isCurrent = idx === stats.weeksLivedClamped;
              dots.push(<circle key={idx} cx={x} cy={y} r={isCurrent?2.2:1.3} fill={weekColorFor(idx)} />);
            }
          }
          return (
            <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
              <g className="svg-rotate">{dots}</g>
              <text x={cx} y={cy - 4} textAnchor="middle" fontSize="32" fontWeight="800" fill={themeColors.hex.text}>
                {stats.percentageLived}%
              </text>
            </svg>
          );
        };

        const renderSpiral = () => {
          const W=340,H=340, cx=W/2, cy=H/2;
          const turns=14, maxR=150;
          const dots = [];
          for (let i=0; i<WEEKS; i++) {
            const tt = i/(WEEKS-1);
            const ang = tt*Math.PI*2*turns - Math.PI/2;
            const r = 10 + tt*(maxR-10);
            const x = cx + r*Math.cos(ang);
            const y = cy + r*Math.sin(ang);
            const isCurrent = i === stats.weeksLivedClamped;
            dots.push(<circle key={i} cx={x} cy={y} r={isCurrent?2.4:1.1} fill={weekColorFor(i)} />);
          }
          return (
            <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
              <g className="svg-rotate">{dots}</g>
            </svg>
          );
        };

        const renderColumns = () => {
          const cols = [];
          for (let y=0; y<80; y++) {
            const blocks = [];
            for (let w=0; w<52; w++) {
              const idx = y*52 + w;
              const isCurrent = idx === stats.weeksLivedClamped;
              blocks.push(
                <div key={idx}
                  className={"w-2 h-2 rounded-[2px] " + (isCurrent ? "animate-pulse" : "")}
                  style={{ backgroundColor: weekColorFor(idx) }} />
              );
            }
            cols.push(<div key={y} className="flex flex-col-reverse gap-[2px]">{blocks}</div>);
          }
          return <div className="flex gap-[3px] justify-center overflow-x-auto pb-1 wiggle">{cols}</div>;
        };

        const renderConstellation = () => {
          const W=340,H=340;
          const seed = hashToUint(currentUser.username + "|" + birthdate);
          const rng = makeRng(seed);
          const pts = [];
          for (let i=0;i<WEEKS;i++) {
            const a = rng()*Math.PI*2;
            const r = Math.sqrt(rng()) * 150;
            const x = W/2 + r*Math.cos(a);
            const y = H/2 + r*Math.sin(a);
            const isCurrent = i === stats.weeksLivedClamped;
            const tw = (i % 17 === 0) ? "twinkle" : "";
            pts.push(<circle key={i} cx={x} cy={y} r={isCurrent?2.6:1.1} fill={weekColorFor(i)} opacity={isCurrent?1:0.9} className={tw} />);
          }
          return (
            <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
              <g className="svg-rotate">{pts}</g>
            </svg>
          );
        };

        switch (design) {
          case "grid": return renderGrid();
          case "snake": return renderSnake();
          case "wave": return renderWave();
          case "circle": return renderCircle();
          case "spiral": return renderSpiral();
          case "columns": return renderColumns();
          case "constellation": return renderConstellation();
          default: return renderGrid();
        }
      }, [design, stats?.weeksLivedClamped, stats?.percentageLived, themeColors, currentUser?.username, birthdate]);

      // ================== SCREENS ==================
      function SettingsScreen() {
        return (
          <div className={`min-h-screen safe-bottom safe-top ${themeColors.bg} ${themeColors.text} p-4`}>
            <div className="max-w-md mx-auto pt-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">{t("settings")}</h2>
                <button onClick={() => setShowSettings(false)} className={themeColors.textSecondary} aria-label={t("close")}>
                  <XIcon />
                </button>
              </div>

              <Accordion title={t("language")} themeColors={themeColors} defaultOpen={true}>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setLang("es")} className={`p-3 rounded-xl border ${themeColors.border} ${lang==="es" ? "ring-2 ring-black/20" : ""}`}>{t("spanish")}</button>
                  <button onClick={() => setLang("en")} className={`p-3 rounded-xl border ${themeColors.border} ${lang==="en" ? "ring-2 ring-black/20" : ""}`}>{t("english")}</button>
                </div>
              </Accordion>

              <Accordion title={t("theme")} themeColors={themeColors}>
                <div className="grid grid-cols-2 gap-2">
                  {Object.keys(THEMES).map(k => (
                    <button key={k} onClick={() => setTheme(k)} className={`p-3 rounded-xl border ${themeColors.border} ${theme===k ? "ring-2 ring-black/20" : ""}`}>
                      {THEMES[k].label[lang] || THEMES[k].label.en}
                    </button>
                  ))}
                </div>
              </Accordion>

              <Accordion title={t("design")} themeColors={themeColors}>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {id:"grid", label:{es:"Cuadrícula", en:"Grid"}},
                    {id:"circle", label:{es:"Anillos", en:"Rings"}},
                    {id:"wave", label:{es:"Ondas", en:"Waves"}},
                    {id:"spiral", label:{es:"Espiral", en:"Spiral"}},
                    {id:"columns", label:{es:"Columnas", en:"Columns"}},
                    {id:"constellation", label:{es:"Constelación", en:"Constellation"}},
                    {id:"snake", label:{es:"Serpiente", en:"Snake"}},
                  ].map(d => (
                    <button key={d.id} onClick={() => setDesign(d.id)} className={`p-3 rounded-xl border ${themeColors.border} ${design===d.id ? "ring-2 ring-black/20" : ""}`}>
                      {d.label[lang] || d.label.en}
                    </button>
                  ))}
                </div>
              </Accordion>

              <Accordion title={t("optionalNumbers")} themeColors={themeColors}>
                <div className={`${themeColors.textSecondary} text-xs mb-3`}>
                  {lang==="es" ? "Opcional. Si no tocas nada, usa valores por defecto." : "Optional. If you don’t change anything, defaults are used."}
                </div>
                <div className="space-y-2">
                  <label className="text-sm">{lang==="es" ? "Población al nacer" : "Population at birth"}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                    value={context.populationAtBirth} onChange={(e)=>setContext(c=>({...c, populationAtBirth: e.target.value}))} />
                  <label className="text-sm">{lang==="es" ? "Población actual" : "Population now"}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                    value={context.populationNow} onChange={(e)=>setContext(c=>({...c, populationNow: e.target.value}))} />
                  <label className="text-sm">{lang==="es" ? "Nacimientos/año" : "Births/year"}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                    value={context.birthsPerYear} onChange={(e)=>setContext(c=>({...c, birthsPerYear: e.target.value}))} />
                  <label className="text-sm">{lang==="es" ? "Muertes/año" : "Deaths/year"}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                    value={context.deathsPerYear} onChange={(e)=>setContext(c=>({...c, deathsPerYear: e.target.value}))} />
                  <button onClick={() => updateCurrentUser({ context: { ...context } })}
                    className={`mt-2 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-2 rounded-xl font-medium`}>
                    {t("save")}
                  </button>
                </div>
              </Accordion>

              <Accordion title={t("exportHintTitle")} themeColors={themeColors}>
                <div className={`${themeColors.textSecondary} text-xs mb-3`}>{t("exportHintBody")}</div>

                <div className="grid grid-cols-2 gap-2">
                  <button onClick={doExport} className={`p-3 rounded-xl border ${themeColors.border} font-semibold`}>
                    {t("exportData")}
                  </button>
                  <button onClick={doImport} className={`p-3 rounded-xl border ${themeColors.border} font-semibold`}>
                    {t("importData")}
                  </button>
                </div>

                <textarea className={`mt-2 w-full p-3 rounded-xl border ${themeColors.border} bg-transparent text-xs`}
                  rows="4" placeholder={lang==="es" ? "Pega aquí para importar…" : "Paste here to import…"}
                  value={importCode} onChange={(e)=>setImportCode(e.target.value)} />
                {importMsg && <div className="mt-2 text-sm">{importMsg}</div>}

                {exportCode && (
                  <div className="mt-3">
                    <textarea className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent text-xs`} rows="5"
                      value={exportCode} readOnly onFocus={(e)=>e.target.select()} />
                    <button onClick={copyExport} className={`mt-2 w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                      {copyState==="copied" ? t("copied") : t("copy")}
                    </button>
                  </div>
                )}
              </Accordion>

              {/* Bottom: logout */}
              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-4 mt-4`}>
                <button onClick={logout} className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold">
                  {t("logout")}
                </button>
              </div>
            </div>
          </div>
        );
      }

      function Onboarding() {
        return (
          <div className={`min-h-screen safe-bottom safe-top ${themeColors.bg} ${themeColors.text} flex items-center justify-center p-4`}>
            <div className="max-w-md w-full">
              <h1 className="text-3xl font-bold text-center">{t("appTitle")}</h1>
              <p className={`${themeColors.textSecondary} text-center mt-2 mb-6`}>{t("appSubtitle")}</p>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5`}>
                {flow === "welcome" && (
                  <div className="space-y-3 fade-in">
                    <div className="font-semibold">{t("chooseAuth")}</div>
                    <button onClick={() => setFlow("register")}
                      className={`w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold`}>
                      {t("createNew")}
                    </button>
                    <button onClick={() => setFlow("login")}
                      className={`w-full border ${themeColors.border} py-3 rounded-xl font-semibold`}>
                      {t("alreadyHave")}
                    </button>

                    <button onClick={() => setShowSettings(true)}
                      className={`mt-2 w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                      {t("settings")}
                    </button>
                  </div>
                )}

                {(flow === "register" || flow === "login") && (
                  <div className="space-y-3 fade-in">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">{flow === "register" ? t("register") : t("login")}</div>
                      <button onClick={() => setFlow("welcome")} className={themeColors.textSecondary}>{lang==="es" ? "Atrás" : "Back"}</button>
                    </div>

                    <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                      placeholder={t("username")} value={authUser}
                      onChange={(e) => setAuthUser(e.target.value)}
                      autoCapitalize="none" autoCorrect="off" />

                    <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                      placeholder={t("password")} type="password"
                      value={authPass} onChange={(e) => setAuthPass(e.target.value)} />

                    {authMsg && <div className="text-sm text-red-600">{authMsg}</div>}

                    <button onClick={flow === "register" ? doRegister : doLogin}
                      className={`w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold`}>
                      {flow === "register" ? t("register") : t("login")}
                    </button>

                    <button onClick={() => setShowSettings(true)}
                      className={`w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                      {t("settings")}
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      function BirthdateStep() {
        return (
          <div className={`min-h-screen safe-bottom safe-top ${themeColors.bg} ${themeColors.text} flex items-center justify-center p-4`}>
            <div className="max-w-md w-full">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <div className="text-2xl font-bold">{t("setBirthdate")}</div>
                  <div className={`${themeColors.textSecondary} text-sm`}>{currentUser?.username}</div>
                </div>
                <button onClick={() => setShowSettings(true)} className={themeColors.textSecondary} aria-label={t("settings")}>
                  <SettingsIcon />
                </button>
              </div>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5`}>
                <label className="block mb-2 font-medium">{t("whenBorn")}</label>
                <input type="date"
                  className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                  value={tempBirthdate} onChange={(e) => setTempBirthdate(e.target.value)} />
                {dateError && <div className="mt-2 text-sm text-red-600">{dateError}</div>}

                <button onClick={saveBirthdate} disabled={!tempBirthdate}
                  className={`mt-3 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold disabled:opacity-50`}>
                  {t("done")}
                </button>
              </div>
            </div>
          </div>
        );
      }

      function Home() {
        if (!stats || stats.invalid) return null;

        const moodCells = moodHistory(90);
        const intro = dailyInsights?.intro || ["", ""];
        const socialLines = dailyInsights?.social || [];
        const cosmicLines = dailyInsights?.cosmic || [];
        const natureLines = dailyInsights?.nature || [];
        const highlights = lifeHighlightsLines(lang, stats);

        return (
          <div className={`min-h-screen safe-bottom safe-top ${themeColors.bg} ${themeColors.text}`}>
            <div className="max-w-md mx-auto p-4 pt-6">

              {showBirthdayCard && (
                <div className="rounded-2xl p-4 border border-black/10 mb-4 fade-in"
                  style={{ background:"linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.55))" }}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 font-semibold"><PartyIcon /> {t("birthdayTitle")}</div>
                    <button onClick={dismissBirthdayCard} className="text-sm text-gray-600">{t("birthdayDismiss")}</button>
                  </div>
                  <div className="text-sm text-gray-700 mt-2">
                    {lang==="es" ? "Tienes una carta basada en tu año (según tus emociones)." : "You have a letter based on your year (from your moods)."}
                  </div>
                  <button onClick={() => { setShowBirthdayModal(true); updateCurrentUser({ birthdayShownISO: isoToday() }); setShowBirthdayCard(false); }}
                    className={`mt-3 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-2 rounded-xl font-semibold`}>
                    {t("birthdayOpen")}
                  </button>
                </div>
              )}

              <div className="flex justify-between items-center mb-6">
                <div>
                  <h1 className="text-2xl font-bold">{t("yourLife")}</h1>
                  <p className={themeColors.textSecondary + " text-sm"}>
                    {stats.yearsLived} {lang==="es" ? "años" : "years"}, {stats.monthsLived} {lang==="es" ? "meses" : "months"}
                  </p>
                </div>
                <button onClick={() => setShowSettings(true)} className={themeColors.textSecondary} aria-label={t("settings")}>
                  <SettingsIcon />
                </button>
              </div>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-4 mb-4`}>
                <div className="text-sm font-semibold">{intro[0]}</div>
                <div className={`${themeColors.textSecondary} text-sm mt-1`}>{intro[1]}</div>
              </div>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5 mb-4`}>
                <div className="design-shell">
                  <div className="design-shell-inner">
                    {designNode}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-4">
                <div className={`${themeColors.card} border ${themeColors.border} p-4 rounded-2xl`}>
                  <div className={`${themeColors.textSecondary} text-sm`}>{t("weeksLived")}</div>
                  <div className="text-2xl font-bold">{stats.weeksLived.toLocaleString()}</div>
                </div>
                <div className={`${themeColors.card} border ${themeColors.border} p-4 rounded-2xl`}>
                  <div className={`${themeColors.textSecondary} text-sm`}>{t("daysLived")}</div>
                  <div className="text-2xl font-bold">{stats.daysLived.toLocaleString()}</div>
                </div>
              </div>

              <div className={`${themeColors.card} border ${themeColors.border} p-6 rounded-2xl mb-4`}>
                <div className="flex justify-between items-center mb-2">
                  <span className={themeColors.textSecondary}>{t("lifeProgress")}</span>
                  <span className="text-2xl font-bold">{stats.percentageLived}%</span>
                </div>
                <div className={`w-full rounded-full h-3 overflow-hidden ${themeColors.track}`}>
                  <div className={`${themeColors.accent} h-full rounded-full transition-all duration-700`} style={{ width: `${stats.percentageLived}%` }} />
                </div>
                <div className={`${themeColors.textSecondary} text-sm mt-3`}>
                  {t("weeksLeft")} {stats.weeksRemaining.toLocaleString()} {t("weeks")}
                </div>
              </div>

              {/* Life highlights (NO rotan) */}
              <div className={`${themeColors.card} border ${themeColors.border} p-6 rounded-2xl mb-4`}>
                <div className="font-semibold mb-2">{t("highlights")}</div>
                <ul className={`space-y-2 ${themeColors.textSecondary}`}>
                  {highlights.map((l,i) => <li key={i} className="text-sm leading-relaxed">• {l}</li>)}
                </ul>
              </div>

              {/* Mood */}
              <div className={`${themeColors.card} border ${themeColors.border} p-6 rounded-2xl mb-4`}>
                <div className="flex justify-between items-center mb-2">
                  <span className="font-semibold">{t("mood")}</span>
                  <span className={`${themeColors.textSecondary} text-xs`}>{t("history90")}</span>
                </div>

                <div className="grid gap-[3px]" style={{ gridTemplateColumns: "repeat(15, minmax(0, 1fr))" }}>
                  {moodCells.map((d) => {
                    const mood = moodById(d.id);
                    const col = mood ? mood.color : (theme === "dark" || theme === "neon" ? "#0b0b0f" : "#e5e7eb");
                    return (
                      <div key={d.iso} className="w-full aspect-square rounded-[3px]"
                        style={{ backgroundColor: col }}
                        title={`${d.iso}${mood ? " · " + (mood.label[lang] || mood.label.en) : ""}`} />
                    );
                  })}
                </div>

                <button onClick={() => setShowMoodModal(true)}
                  className={`mt-4 w-full p-3 rounded-xl border ${themeColors.border} font-semibold`}>
                  {t("moodLogNow")}
                </button>
              </div>

              {/* Rotating context */}
              <Accordion title={t("societal")} themeColors={themeColors}>
                <ul className={`space-y-2 ${themeColors.textSecondary}`}>
                  {socialLines.map((l,i) => <li key={i} className="text-sm leading-relaxed">• {l}</li>)}
                </ul>
              </Accordion>
              <Accordion title={t("cosmic")} themeColors={themeColors}>
                <ul className={`space-y-2 ${themeColors.textSecondary}`}>
                  {cosmicLines.map((l,i) => <li key={i} className="text-sm leading-relaxed">• {l}</li>)}
                </ul>
              </Accordion>
              <Accordion title={t("nature")} themeColors={themeColors}>
                <ul className={`space-y-2 ${themeColors.textSecondary}`}>
                  {natureLines.map((l,i) => <li key={i} className="text-sm leading-relaxed">• {l}</li>)}
                </ul>
              </Accordion>
            </div>

            {/* Mood modal */}
            <Modal open={showMoodModal} onClose={() => setShowMoodModal(false)}>
              <div className="mb-2 text-lg font-bold">{t("moodTodayTitle")}</div>
              <div className="text-sm text-gray-600 mb-3">{t("moodTodaySubtitle")}</div>
              <div className="grid grid-cols-2 gap-2">
                {MOODS.map(m => (
                  <PillButton key={m.id} label={m.label[lang] || m.label.en} color={m.color} onClick={() => saveMood(m.id)} />
                ))}
              </div>
              <button onClick={() => setShowMoodModal(false)} className="mt-3 w-full p-3 rounded-xl border border-black/10 font-medium">
                {t("skip")}
              </button>
            </Modal>

            {/* Birthday modal placeholder (simple) */}
            <Modal open={showBirthdayModal} onClose={() => setShowBirthdayModal(false)}>
              <div className="text-lg font-bold mb-2">{t("birthdayLetter")}</div>
              <div className="text-sm text-gray-700">
                {lang==="es"
                  ? "Carta decorada (versión final). Si quieres la carta larga con recomendaciones por emociones, te la integro aquí en el siguiente mensaje."
                  : "Decorated letter (final version). If you want the long letter with mood-based recommendations, I’ll integrate it here next."}
              </div>
            </Modal>
          </div>
        );
      }

      // Router
      if (showSettings && currentUser) return <SettingsScreen />;
      if (!currentUser) return <Onboarding />;
      if (flow === "setBirthdate" || !birthdate) return <BirthdateStep />;
      return <Home />;
    }

    // ================== APP WRAPPER (error-safe) ==================
    function AppWithSafety() {
      const [lang, setLang] = useState("es");
      const fallback = (error) => {
        const t = (k) => I18N[lang]?.[k] ?? I18N.en?.[k] ?? k;
        return (
          <div className="min-h-screen safe-bottom safe-top bg-white text-gray-900 flex items-center justify-center p-4">
            <div className="max-w-md w-full border border-gray-200 rounded-2xl p-5 bg-gray-50">
              <div className="text-2xl font-bold mb-2">{t("errorTitle")}</div>
              <div className="text-sm text-gray-700 mb-4">{t("errorBody")}</div>
              <button
                onClick={() => { safeDel(KEYS.session); safeDel(KEYS.users); location.reload(); }}
                className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold"
              >
                {t("reset")}
              </button>
              <div className="text-xs text-gray-500 mt-3 break-words">
                {String(error || "")}
              </div>
            </div>
          </div>
        );
      };

      return (
        <ErrorBoundary fallback={fallback}>
          <App />
        </ErrorBoundary>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<AppWithSafety />);
  </script>
</body>
</html>
