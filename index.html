<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Tu Vida en Semanas</title>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }

    html, body { height: 100%; }
    body { margin: 0; overflow-x: hidden; min-height: 100dvh; }
    #root { min-height: 100dvh; }

    .safe-bottom { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

    .fade-in { animation: fadeIn .25s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }

    /* iOS details marker */
    summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ================== SAFE STORAGE ==================
    const KEYS = {
      session: "wol_session_v2",
      users: "wol_users_v2",
    };
    const safeGet = (k) => { try { return localStorage.getItem(k); } catch { return null; } };
    const safeSet = (k, v) => { try { localStorage.setItem(k, v); } catch {} };
    const loadJSON = (k, fb) => { const r = safeGet(k); if (!r) return fb; try { return JSON.parse(r); } catch { return fb; } };
    const saveJSON = (k, o) => safeSet(k, JSON.stringify(o));

    // ================== ICONS ==================
    const SettingsIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
      </svg>
    );
    const XIcon = () => (
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    const ChevronIcon = ({ open }) => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true"
        style={{ transform: open ? "rotate(180deg)" : "rotate(0deg)", transition: "transform .15s ease" }}>
        <path d="M6 9l6 6 6-6"></path>
      </svg>
    );
    const PartyIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
        <path d="M8 21s8-2 12-12c0 0-8 2-12 12z"></path>
        <path d="M3 7l6 2-2-6-4 4z"></path>
      </svg>
    );

    // ================== HELPERS ==================
    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
    const fmtInt = (n) => Math.round(n).toLocaleString(undefined);

    function parseISODateToLocalMidnight(iso) {
      const parts = (iso || "").split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]), m = Number(parts[1]), d = Number(parts[2]);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m - 1, d, 0, 0, 0, 0);
      if (Number.isNaN(dt.getTime())) return null;
      return dt;
    }

    function isoToday() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function isBirthdayToday(birthISO) {
      const b = parseISODateToLocalMidnight(birthISO);
      if (!b) return false;
      const now = new Date();
      return (b.getMonth() === now.getMonth()) && (b.getDate() === now.getDate());
    }

    // ================== SEEDED RNG (daily stable) ==================
    function hashToUint(str) {
      // simple deterministic hash
      let h = 2166136261 >>> 0;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }
    function makeRng(seed) {
      let x = seed >>> 0;
      return () => {
        // xorshift32
        x ^= x << 13; x >>>= 0;
        x ^= x >>> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x >>> 0) / 4294967296;
      };
    }
    function pickNUnique(arr, n, rng) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, Math.min(n, a.length));
    }

    // ================== CRYPTO HASH (password) ==================
    async function sha256Hex(text) {
      if (crypto?.subtle?.digest) {
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      // fallback (less secure, but functional offline)
      return String(hashToUint(text));
    }
    async function passwordHash(username, password) {
      return await sha256Hex("wol:v2:" + username + ":" + password);
    }

    // ================== THEMES ==================
    const THEMES = {
      minimal: {
        label: { es: "Minimal", en: "Minimal" },
        bg: "bg-white",
        text: "text-gray-900",
        textSecondary: "text-gray-600",
        card: "bg-gray-50",
        border: "border-gray-200",
        accent: "bg-gray-900",
        accentHover: "hover:bg-gray-800",
        track: "bg-gray-200",
        hex: { text:"#111827", textSecondary:"#4b5563", weekPast:"#111827", weekFuture:"#e5e7eb", weekCurrent:"#3b82f6", accent:"#111827", track:"#e5e7eb" }
      },
      dark: {
        label: { es: "Oscuro", en: "Dark" },
        bg: "bg-gray-950",
        text: "text-gray-100",
        textSecondary: "text-gray-400",
        card: "bg-gray-900",
        border: "border-gray-800",
        accent: "bg-purple-600",
        accentHover: "hover:bg-purple-700",
        track: "bg-gray-800",
        hex: { text:"#f3f4f6", textSecondary:"#9ca3af", weekPast:"#a855f7", weekFuture:"#1f2937", weekCurrent:"#06b6d4", accent:"#7c3aed", track:"#1f2937" }
      },
      warm: {
        label: { es: "CÃ¡lido", en: "Warm" },
        bg: "bg-amber-50",
        text: "text-amber-950",
        textSecondary: "text-amber-700",
        card: "bg-amber-100",
        border: "border-amber-300",
        accent: "bg-orange-600",
        accentHover: "hover:bg-orange-700",
        track: "bg-amber-200",
        hex: { text:"#451a03", textSecondary:"#b45309", weekPast:"#ea580c", weekFuture:"#fde68a", weekCurrent:"#ef4444", accent:"#ea580c", track:"#fde68a" }
      },
      ocean: {
        label: { es: "OcÃ©ano", en: "Ocean" },
        bg: "bg-sky-50",
        text: "text-slate-900",
        textSecondary: "text-slate-600",
        card: "bg-sky-100",
        border: "border-sky-300",
        accent: "bg-blue-600",
        accentHover: "hover:bg-blue-700",
        track: "bg-sky-200",
        hex: { text:"#0f172a", textSecondary:"#475569", weekPast:"#2563eb", weekFuture:"#bae6fd", weekCurrent:"#14b8a6", accent:"#2563eb", track:"#bae6fd" }
      },
      forest: {
        label: { es: "Bosque", en: "Forest" },
        bg: "bg-emerald-50",
        text: "text-emerald-950",
        textSecondary: "text-emerald-700",
        card: "bg-emerald-100",
        border: "border-emerald-300",
        accent: "bg-emerald-700",
        accentHover: "hover:bg-emerald-800",
        track: "bg-emerald-200",
        hex: { text:"#064e3b", textSecondary:"#047857", weekPast:"#047857", weekFuture:"#a7f3d0", weekCurrent:"#22c55e", accent:"#047857", track:"#a7f3d0" }
      },
      rose: {
        label: { es: "Rosa", en: "Rose" },
        bg: "bg-rose-50",
        text: "text-rose-950",
        textSecondary: "text-rose-700",
        card: "bg-rose-100",
        border: "border-rose-300",
        accent: "bg-rose-600",
        accentHover: "hover:bg-rose-700",
        track: "bg-rose-200",
        hex: { text:"#4c0519", textSecondary:"#be123c", weekPast:"#be123c", weekFuture:"#fecdd3", weekCurrent:"#fb7185", accent:"#e11d48", track:"#fecdd3" }
      },
      neon: {
        label: { es: "NeÃ³n", en: "Neon" },
        bg: "bg-black",
        text: "text-white",
        textSecondary: "text-zinc-300",
        card: "bg-zinc-900",
        border: "border-zinc-800",
        accent: "bg-fuchsia-600",
        accentHover: "hover:bg-fuchsia-700",
        track: "bg-zinc-800",
        hex: { text:"#ffffff", textSecondary:"#d4d4d8", weekPast:"#fuchsia", weekFuture:"#27272a", weekCurrent:"#22c55e", accent:"#d946ef", track:"#27272a" }
      },
      slate: {
        label: { es: "Grafito", en: "Slate" },
        bg: "bg-slate-50",
        text: "text-slate-950",
        textSecondary: "text-slate-600",
        card: "bg-slate-100",
        border: "border-slate-300",
        accent: "bg-slate-800",
        accentHover: "hover:bg-slate-900",
        track: "bg-slate-200",
        hex: { text:"#0f172a", textSecondary:"#475569", weekPast:"#334155", weekFuture:"#cbd5e1", weekCurrent:"#0ea5e9", accent:"#1f2937", track:"#cbd5e1" }
      }
    };

    // ================== I18N ==================
    const I18N = {
      es: {
        appTitle: "Tu vida en semanas",
        appSubtitle: "Visualiza tu tiempo (80 aÃ±os = 4160 semanas)",
        next: "Siguiente",
        back: "AtrÃ¡s",
        skip: "Omitir",
        settings: "Ajustes",
        close: "Cerrar",
        start: "Empezar",
        save: "Guardar",
        language: "Idioma",
        spanish: "EspaÃ±ol",
        english: "InglÃ©s",
        theme: "Tema",
        design: "DiseÃ±o",
        profile: "Perfil",
        account: "Cuenta",
        register: "Registrarme",
        login: "Iniciar sesiÃ³n",
        username: "Usuario",
        password: "ContraseÃ±a",
        logout: "Cerrar sesiÃ³n",
        exportData: "Exportar datos",
        importData: "Importar",
        exportHintTitle: "Llevar tu perfil a otro dispositivo",
        exportHintBody: "Ajustes â†’ abajo â†’ Exportar datos. Copia el cÃ³digo y pÃ©galo en el otro mÃ³vil en Importar.",
        copy: "Copiar",
        copied: "Copiado",
        whenBorn: "Â¿CuÃ¡ndo naciste?",
        yourLife: "Tu vida",
        weeksLived: "Semanas vividas",
        daysLived: "DÃ­as vividos",
        lifeProgress: "Progreso",
        weeksLeft: "Te quedan aprox.",
        weeks: "semanas",
        invalidFuture: "La fecha no puede ser en el futuro.",
        moodTodayTitle: "Â¿CÃ³mo estÃ¡s hoy?",
        moodTodaySubtitle: "Un toque y queda guardado.",
        moodLogNow: "Registrar Ã¡nimo ahora",
        mood: "Estado de Ã¡nimo",
        history90: "Historial (90 dÃ­as)",
        highlights: "Life highlights",
        societal: "Contexto social",
        cosmic: "Perspectiva cÃ³smica",
        nature: "Mundo natural",
        more: "Ver mÃ¡s",
        less: "Ver menos",
        optionalNumbers: "Datos numÃ©ricos (opcional)",
        populationAtBirth: "PoblaciÃ³n mundial al nacer",
        populationNow: "PoblaciÃ³n mundial actual",
        birthsPerYear: "Nacimientos globales por aÃ±o",
        deathsPerYear: "Muertes globales por aÃ±o",
        birthdayTitle: "Â¡Feliz cumpleaÃ±os!",
        birthdayDismiss: "Ver luego",
        birthdayOpen: "Leer carta",
        birthdayLetter: "Carta",
        onboardingTitle: "Bienvenido",
        onboardingSubtitle: "Vamos paso a paso.",
        chooseAuth: "Â¿QuÃ© quieres hacer?",
        alreadyHave: "Ya tengo cuenta",
        createNew: "Crear cuenta",
        setBirthdate: "Vamos a guardar tu fecha de nacimiento",
        done: "Listo",
      },
      en: {
        appTitle: "Your life in weeks",
        appSubtitle: "Visualize your time (80 years = 4,160 weeks)",
        next: "Next",
        back: "Back",
        skip: "Skip",
        settings: "Settings",
        close: "Close",
        start: "Start",
        save: "Save",
        language: "Language",
        spanish: "Spanish",
        english: "English",
        theme: "Theme",
        design: "Design",
        profile: "Profile",
        account: "Account",
        register: "Sign up",
        login: "Log in",
        username: "Username",
        password: "Password",
        logout: "Log out",
        exportData: "Export data",
        importData: "Import",
        exportHintTitle: "Move your profile to another device",
        exportHintBody: "Settings â†’ bottom â†’ Export data. Copy the code and paste it on the other phone using Import.",
        copy: "Copy",
        copied: "Copied",
        whenBorn: "When were you born?",
        yourLife: "Your life",
        weeksLived: "Weeks lived",
        daysLived: "Days lived",
        lifeProgress: "Progress",
        weeksLeft: "You have approx.",
        weeks: "weeks left",
        invalidFuture: "Birthdate cannot be in the future.",
        moodTodayTitle: "How are you today?",
        moodTodaySubtitle: "Tap once and itâ€™s saved.",
        moodLogNow: "Log mood now",
        mood: "Mood",
        history90: "History (90 days)",
        highlights: "Life highlights",
        societal: "Societal context",
        cosmic: "Cosmic perspective",
        nature: "Natural world",
        more: "Show more",
        less: "Show less",
        optionalNumbers: "Numeric context (optional)",
        populationAtBirth: "World population at birth",
        populationNow: "Current world population",
        birthsPerYear: "Global births per year",
        deathsPerYear: "Global deaths per year",
        birthdayTitle: "Happy Birthday!",
        birthdayDismiss: "Later",
        birthdayOpen: "Read letter",
        birthdayLetter: "Letter",
        onboardingTitle: "Welcome",
        onboardingSubtitle: "Letâ€™s do it step by step.",
        chooseAuth: "What do you want to do?",
        alreadyHave: "I already have an account",
        createNew: "Create an account",
        setBirthdate: "Letâ€™s save your birthdate",
        done: "Done",
      }
    };

    // ================== MOODS ==================
    const MOODS = [
      { id:"happy",    label:{es:"Contento", en:"Happy"},    color:"#22c55e", kind:"pos" },
      { id:"calm",     label:{es:"Calmado", en:"Calm"},      color:"#06b6d4", kind:"pos" },
      { id:"focused",  label:{es:"Enfocado", en:"Focused"},  color:"#3b82f6", kind:"pos" },
      { id:"grateful", label:{es:"Agradecido", en:"Grateful"}, color:"#eab308", kind:"pos" },
      { id:"tired",    label:{es:"Cansado", en:"Tired"},     color:"#a3a3a3", kind:"neg" },
      { id:"sad",      label:{es:"Triste", en:"Sad"},        color:"#6366f1", kind:"neg" },
      { id:"angry",    label:{es:"Enfadado", en:"Angry"},    color:"#ef4444", kind:"neg" },
      { id:"anxious",  label:{es:"Ansioso", en:"Anxious"},   color:"#f59e0b", kind:"neg" },
    ];
    const moodById = (id) => MOODS.find(m => m.id === id) || null;

    // ================== DEFAULT CONTEXT ==================
    const DEFAULT_CONTEXT = {
      populationAtBirth: 6900000000,
      populationNow: 8100000000,
      birthsPerYear: 140000000,
      deathsPerYear: 60000000,
    };

    // ================== STATS ==================
    function computeStats(birthISO, context) {
      const birth = parseISODateToLocalMidnight(birthISO);
      if (!birth) return null;
      const now = new Date();
      if (birth.getTime() > now.getTime()) return { invalid:true, messageKey:"invalidFuture" };

      const msDay = 86400000;
      const msWeek = msDay * 7;
      const diffMs = now.getTime() - birth.getTime();

      const daysLived = Math.floor(diffMs / msDay);
      const weeksLived = Math.floor(diffMs / msWeek);

      const totalWeeks = 4160;
      const weeksLivedClamped = clamp(weeksLived, 0, totalWeeks);
      const weeksRemaining = Math.max(0, totalWeeks - weeksLivedClamped);
      const pct = clamp(Math.round((weeksLivedClamped / totalWeeks) * 100), 0, 100);

      const yearsLived = Math.floor(daysLived / 365.2425);
      const monthsLived = Math.floor((daysLived % 365.2425) / 30.436875);

      // highlights assumptions
      const minutesLived = Math.floor(diffMs / 60000);
      const heartBeats = minutesLived * 72;
      const breaths = minutesLived * 16;
      const sleepHours = daysLived * 8;

      const seasons = Math.floor(daysLived / (365.2425 / 4));
      const lunarCycles = Math.floor(daysLived / 29.53059);
      const tripsAroundSun = Math.floor(daysLived / 365.2425);

      const AU_KM = 149_597_870.7;
      const earthOrbitKmPerYear = 2 * Math.PI * AU_KM;
      const earthAroundSunKm = (daysLived / 365.2425) * earthOrbitKmPerYear;

      const secondsLived = Math.floor(diffMs / 1000);
      const solarSystemKm = secondsLived * 220;

      const universeAgeYears = 13_800_000_000;
      const lifespanPercentOfUniverse = ((daysLived / 365.2425) / universeAgeYears) * 100;

      // societal estimates using context
      const years = daysLived / 365.2425;
      const births = years * Number(context.birthsPerYear || 0);
      const deaths = years * Number(context.deathsPerYear || 0);

      return {
        invalid:false,
        birth, now,
        totalWeeks,
        weeksLived, weeksLivedClamped, weeksRemaining,
        percentageLived: pct,
        daysLived, yearsLived, monthsLived,
        heartBeats, breaths, sleepHours, seasons,
        lunarCycles, tripsAroundSun,
        earthAroundSunKm, solarSystemKm, lifespanPercentOfUniverse,
        estBirths: births, estDeaths: deaths
      };
    }

    // ================== DAILY INSIGHTS (varÃ­an cada dÃ­a) ==================
    function buildInsightPools(lang, stats, context) {
      const L = lang;
      const popStart = Number(context.populationAtBirth || 0);
      const popNow = Number(context.populationNow || 0);

      const meetTotal = 80000;
      const metLikely = clamp(Math.round(meetTotal * (stats.percentageLived / 100)), 0, meetTotal);

      const social = [
        () => (L==="es")
          ? `Durante tu vida, la poblaciÃ³n mundial pasÃ³ de ~${fmtInt(popStart)} a ~${fmtInt(popNow)}.`
          : `During your lifetime, world population moved from ~${fmtInt(popStart)} to ~${fmtInt(popNow)}.`,
        () => (L==="es")
          ? `La media dice ~${fmtInt(meetTotal)} personas conocidas en una vida. TÃº probablemente ~${fmtInt(metLikely)}.`
          : `Average lifetime meetings: ~${fmtInt(meetTotal)} people. You likely ~${fmtInt(metLikely)}.`,
        () => (L==="es")
          ? `Desde tu nacimiento, el mundo viviÃ³ ~${fmtInt(stats.estBirths)} nacimientos y ~${fmtInt(stats.estDeaths)} muertes (estimaciÃ³n).`
          : `Since your birth: ~${fmtInt(stats.estBirths)} births and ~${fmtInt(stats.estDeaths)} deaths (estimate).`,
        () => (L==="es")
          ? `Tu tiempo no es â€œpocoâ€: es finito. Eso lo hace valioso.`
          : `Your time isnâ€™t â€œsmallâ€: itâ€™s finite. That makes it valuable.`,
        () => (L==="es")
          ? `Una semana buena gana por repeticiÃ³n. No por intensidad.`
          : `A good week wins by repetitionâ€”not intensity.`,
        () => (L==="es")
          ? `Si hoy no fue perfecto, no pasa nada: solo era un dÃ­a, no tu historia completa.`
          : `If today wasnâ€™t perfect, itâ€™s fine: it was one day, not your whole story.`,
      ];

      const cosmic = [
        () => (L==="es")
          ? `Desde que naciste, la Tierra recorriÃ³ ~${fmtInt(stats.earthAroundSunKm)} km alrededor del Sol.`
          : `Since your birth, Earth traveled ~${fmtInt(stats.earthAroundSunKm)} km around the Sun.`,
        () => (L==="es")
          ? `En ese tiempo, el Sistema Solar avanzÃ³ ~${fmtInt(stats.solarSystemKm)} km en la galaxia (aprox.).`
          : `In that time, the Solar System moved ~${fmtInt(stats.solarSystemKm)} km through the galaxy (approx.).`,
        () => (L==="es")
          ? `Tu vida es ~${stats.lifespanPercentOfUniverse.toExponential(3)}% de la edad del universo (aprox.).`
          : `Your life is ~${stats.lifespanPercentOfUniverse.toExponential(3)}% of the universeâ€™s age (approx.).`,
        () => (L==="es")
          ? `Si te agobias, piensa en escala: hoy es una fracciÃ³n. Respira.`
          : `If you feel overwhelmed, zoom out: today is a fraction. Breathe.`,
        () => (L==="es")
          ? `Nada va â€œtardeâ€ en el universo. Va en su ritmo.`
          : `Nothing is â€œlateâ€ in the universe. It moves at its pace.`,
      ];

      const nature = [
        () => (L==="es")
          ? `Has vivido ~${fmtInt(stats.lunarCycles)} ciclos lunares y ~${fmtInt(stats.tripsAroundSun)} vueltas al Sol.`
          : `Youâ€™ve lived ~${fmtInt(stats.lunarCycles)} lunar cycles and ~${fmtInt(stats.tripsAroundSun)} trips around the Sun.`,
        () => (L==="es")
          ? `Dormiste ~${fmtInt(stats.sleepHours)} horas. Tu cuerpo te sostiene mÃ¡s de lo que notas.`
          : `You slept ~${fmtInt(stats.sleepHours)} hours. Your body supports you more than you notice.`,
        () => (L==="es")
          ? `El cambio es normal: incluso tus cÃ©lulas se han renovado varias veces.`
          : `Change is normal: even your cells have renewed multiple times.`,
        () => (L==="es")
          ? `La constancia parece lentaâ€¦ hasta que un dÃ­a se nota.`
          : `Consistency feels slowâ€”until one day it shows.`,
      ];

      return { social, cosmic, nature };
    }

    // ================== INTRO LINES (tambiÃ©n varÃ­an) ==================
    function introPool(lang) {
      const es = [
        ["Preciso. Simple. Real.", "Hoy cuenta, pero no manda."],
        ["Perspectiva frÃ­a, Ãºtil.", "Una semana a la vez."],
        ["No es presiÃ³n, es claridad.", "Tu tiempo se puede ver."],
        ["Si te pierdes, vuelve al ritmo.", "Respira. Avanza."],
        ["La vida no se mide para juzgar.", "Se mide para decidir mejor."],
      ];
      const en = [
        ["Precise. Simple. Real.", "Today matters, but it doesnâ€™t rule you."],
        ["Cold perspective, useful.", "One week at a time."],
        ["Not pressureâ€”clarity.", "You can see your time."],
        ["When you drift, return to rhythm.", "Breathe. Move."],
        ["Time isnâ€™t measured to judge.", "Itâ€™s measured to choose better."],
      ];
      return (lang === "es") ? es : en;
    }

    // ================== BIRTHDAY LETTER ==================
    function analyzeYearMoods(moodsMap) {
      const now = new Date();
      const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 364);
      const counts = {};
      let total = 0;
      let pos = 0, neg = 0;

      let streak = 0, bestStreak = 0;
      let lastDayHad = false;

      // iterate last 365 days (stable)
      for (let i = 364; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const iso = `${y}-${m}-${day}`;
        const moodId = moodsMap?.[iso] || null;
        if (moodId) {
          total++;
          counts[moodId] = (counts[moodId] || 0) + 1;
          const mood = moodById(moodId);
          if (mood?.kind === "pos") pos++;
          if (mood?.kind === "neg") neg++;
          // streak of logged days
          streak = lastDayHad ? (streak + 1) : 1;
          bestStreak = Math.max(bestStreak, streak);
          lastDayHad = true;
        } else {
          streak = 0;
          lastDayHad = false;
        }
      }

      let topMood = null;
      let topCount = 0;
      for (const k of Object.keys(counts)) {
        if (counts[k] > topCount) { topCount = counts[k]; topMood = k; }
      }

      const posRatio = total ? pos / total : 0;
      const negRatio = total ? neg / total : 0;

      return { total, pos, neg, posRatio, negRatio, topMood, topCount, bestStreak };
    }

    function birthdayLetter(lang, user, stats) {
      const A = analyzeYearMoods(user.moods || {});
      const top = moodById(A.topMood);
      const L = lang;

      const tone =
        (A.total < 20) ? "lowdata" :
        (A.posRatio >= 0.6) ? "bright" :
        (A.negRatio >= 0.6) ? "heavy" : "mixed";

      const name = user.username;

      const lines = [];
      if (L==="es") {
        lines.push(`Querido/a ${name},`);
        lines.push("");
        lines.push(`Hoy cumples un aÃ±o mÃ¡s. Y sÃ­: suena tÃ­pico, pero aquÃ­ va lo realâ€”**has sobrevivido y construido** semanas que antes no existÃ­an.`);
        if (tone === "lowdata") {
          lines.push(`Este aÃ±o registraste pocos dÃ­as de Ã¡nimo, pero eso tambiÃ©n dice algo: quizÃ¡ ibas a mil o no te apetecÃ­a medirlo. EstÃ¡ bien.`);
        } else if (tone === "bright") {
          lines.push(`Este aÃ±o tu tendencia fue bastante positiva. No significa â€œperfectoâ€, significa **resiliencia con buen ritmo**.`);
        } else if (tone === "heavy") {
          lines.push(`Este aÃ±o se sintiÃ³ pesado muchas veces. Y aun asÃ­, aquÃ­ estÃ¡s. Eso es fuerza aunque no se vea.`);
        } else {
          lines.push(`Este aÃ±o fue mixto: dÃ­as altos, dÃ­as bajos. Eso es lo normal en una vida que se mueve.`);
        }
        if (A.total >= 20) {
          lines.push(`Tu â€œmoodâ€ mÃ¡s repetido fue **${top?.label?.es || "â€”"}** (${A.topCount} dÃ­as). Tu mejor racha de registro fue de **${A.bestStreak}** dÃ­as.`);
        }
        lines.push("");
        lines.push("### Lo que este aÃ±o te enseÃ±Ã³ (probablemente)");
        if (tone === "bright") {
          lines.push("- Cuando tu base estÃ¡ bien (sueÃ±o/orden), el resto se vuelve mÃ¡s fÃ¡cil.");
          lines.push("- Lo bueno no fue suerte: fue repeticiÃ³n.");
        } else if (tone === "heavy") {
          lines.push("- Aguantar tambiÃ©n cuenta. No todo progreso se ve en el espejo.");
          lines.push("- Pedir aire, bajar el ritmo, y volverâ€¦ es estrategia, no derrota.");
        } else {
          lines.push("- Tu vida no es lineal. Tu progreso tampoco.");
          lines.push("- La estabilidad se construye con cosas pequeÃ±as que se repiten.");
        }
        lines.push("");
        lines.push("### Recomendaciones simples (que funcionan)");
        lines.push("- Elige 1 hÃ¡bito que puedas sostener incluso en dÃ­as malos (10 minutos bastan).");
        lines.push("- Si hay ansiedad o bajÃ³n: camina + luz del sol + agua. BÃ¡sico, pero real.");
        lines.push("- Define 3 prioridades para el prÃ³ximo aÃ±o: salud, relaciones, y un objetivo personal.");
        lines.push("");
        lines.push(`Cierra el dÃ­a con algo mÃ­nimo que te haga sentir que **ganaste**: un mensaje, una ducha, una sesiÃ³n, un pÃ¡rrafo, lo que sea.`);
        lines.push("");
        lines.push("Feliz cumpleaÃ±os. De verdad. ðŸŽ‰");
        lines.push("â€” Tu app (que no te juzga, solo te acompaÃ±a)");
      } else {
        lines.push(`Dear ${name},`);
        lines.push("");
        lines.push(`Today youâ€™re one year older. Sounds clichÃ©â€”so hereâ€™s the real part: you **survived and built** weeks that didnâ€™t exist before.`);
        if (tone === "lowdata") {
          lines.push(`You logged only a few mood days this year, which also says something: maybe life was fast, or you didnâ€™t feel like tracking. Thatâ€™s okay.`);
        } else if (tone === "bright") {
          lines.push(`This year leaned positive. Not â€œperfectâ€â€”more like **resilience with a good rhythm**.`);
        } else if (tone === "heavy") {
          lines.push(`This year felt heavy often. And stillâ€”youâ€™re here. Thatâ€™s strength even if itâ€™s quiet.`);
        } else {
          lines.push(`This year was mixed: highs and lows. Thatâ€™s normal for a life that moves.`);
        }
        if (A.total >= 20) {
          lines.push(`Your most repeated mood was **${top?.label?.en || "â€”"}** (${A.topCount} days). Your best logging streak was **${A.bestStreak}** days.`);
        }
        lines.push("");
        lines.push("### What this year probably taught you");
        if (tone === "bright") {
          lines.push("- When your base is solid (sleep/order), everything gets easier.");
          lines.push("- The good wasnâ€™t luck: it was repetition.");
        } else if (tone === "heavy") {
          lines.push("- Enduring counts. Not all progress is visible.");
          lines.push("- Slowing down, breathing, and returning is strategyâ€”not defeat.");
        } else {
          lines.push("- Life isnâ€™t linear. Progress isnâ€™t either.");
          lines.push("- Stability is built from small things repeated.");
        }
        lines.push("");
        lines.push("### Simple recommendations that work");
        lines.push("- Pick 1 habit you can keep even on bad days (10 minutes is enough).");
        lines.push("- If anxiety hits: walk + sunlight + water. Basic, but real.");
        lines.push("- Define 3 priorities for next year: health, relationships, and one personal goal.");
        lines.push("");
        lines.push(`End today with something small that makes you feel you **won**: a message, a shower, a session, a paragraphâ€”anything.`);
        lines.push("");
        lines.push("Happy birthday. For real. ðŸŽ‰");
        lines.push("â€” Your app (no judgment, just perspective)");
      }

      return lines.join("\n");
    }

    // ================== UI COMPONENTS ==================
    function Modal({ open, onClose, children }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-3">
          <div className="w-full max-w-md rounded-2xl border border-black/10 bg-white/90 glass p-4 fade-in"
               style={{ WebkitBackdropFilter:"blur(10px)", backdropFilter:"blur(10px)" }}>
            <div className="flex justify-end">
              <button onClick={onClose} aria-label="close" className="text-gray-600">
                <XIcon />
              </button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    function Accordion({ title, children, defaultOpen=false, themeColors }) {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl mb-3 overflow-hidden`}>
          <button
            onClick={() => setOpen(o => !o)}
            className="w-full px-4 py-3 flex items-center justify-between"
          >
            <span className="font-semibold">{title}</span>
            <ChevronIcon open={open} />
          </button>
          {open && <div className="px-4 pb-4">{children}</div>}
        </div>
      );
    }

    function PillButton({ label, color, onClick }) {
      return (
        <button onClick={onClick} className="p-3 rounded-xl border border-black/10 flex items-center gap-2 bg-white/60">
          <span className="inline-block w-3 h-3 rounded-sm" style={{ backgroundColor: color }}></span>
          <span>{label}</span>
        </button>
      );
    }

    function Markdownish({ text, themeColors }) {
      // minimal markdown for headings + bullets
      const lines = (text || "").split("\n");
      return (
        <div className="space-y-2">
          {lines.map((l, i) => {
            if (l.startsWith("### ")) {
              return <div key={i} className="text-sm font-semibold mt-3">{l.replace("### ","")}</div>;
            }
            if (l.startsWith("- ")) {
              return <div key={i} className={`${themeColors.textSecondary} text-sm`}>â€¢ {l.slice(2)}</div>;
            }
            if (!l.trim()) return <div key={i} className="h-2"></div>;
            // bold ** **
            const parts = [];
            let s = l;
            while (true) {
              const a = s.indexOf("**");
              if (a === -1) { parts.push({t:s, b:false}); break; }
              const b = s.indexOf("**", a+2);
              if (b === -1) { parts.push({t:s, b:false}); break; }
              parts.push({ t: s.slice(0,a), b:false });
              parts.push({ t: s.slice(a+2,b), b:true });
              s = s.slice(b+2);
            }
            return (
              <div key={i} className={`${themeColors.textSecondary} text-sm leading-relaxed`}>
                {parts.map((p, j) => p.b ? <b key={j} className="text-inherit">{p.t}</b> : <span key={j}>{p.t}</span>)}
              </div>
            );
          })}
        </div>
      );
    }

    // ================== MAIN APP ==================
    function App() {
      const [users, setUsers] = useState(() => loadJSON(KEYS.users, {}));
      const [session, setSession] = useState(() => loadJSON(KEYS.session, null)); // { username }
      const currentUser = session?.username ? users[session.username] : null;

      // onboarding steps (only when no session or missing birthdate)
      const [flow, setFlow] = useState(() => {
        if (!session?.username) return "welcome";
        const u = users[session.username];
        if (!u?.birthdate) return "setBirthdate";
        return "home";
      });

      // auth inputs
      const [authUser, setAuthUser] = useState("");
      const [authPass, setAuthPass] = useState("");
      const [authMsg, setAuthMsg] = useState("");

      // user prefs (from user if logged)
      const [lang, setLang] = useState(currentUser?.prefs?.lang || "es");
      const [theme, setTheme] = useState(currentUser?.prefs?.theme || "minimal");
      const [design, setDesign] = useState(currentUser?.prefs?.design || "grid");
      const [birthdate, setBirthdate] = useState(currentUser?.birthdate || "");
      const [context, setContext] = useState(currentUser?.context || DEFAULT_CONTEXT);

      // UI
      const [showSettings, setShowSettings] = useState(false);
      const [tempBirthdate, setTempBirthdate] = useState("");
      const [dateError, setDateError] = useState("");
      const [showMoodModal, setShowMoodModal] = useState(false);
      const [showBirthdayModal, setShowBirthdayModal] = useState(false);
      const [showBirthdayCard, setShowBirthdayCard] = useState(false);

      // export/import
      const [exportCode, setExportCode] = useState("");
      const [importCode, setImportCode] = useState("");
      const [copyState, setCopyState] = useState("idle"); // idle/copied
      const [importMsg, setImportMsg] = useState("");

      // stats
      const themeColors = useMemo(() => THEMES[theme] || THEMES.minimal, [theme]);
      const t = (k) => I18N[lang]?.[k] ?? I18N.en?.[k] ?? k;

      useEffect(() => saveJSON(KEYS.users, users), [users]);
      useEffect(() => saveJSON(KEYS.session, session), [session]);

      // refresh local state when session changes
      useEffect(() => {
        const u = session?.username ? users[session.username] : null;
        if (!u) return;

        setLang(u.prefs?.lang || "es");
        setTheme(u.prefs?.theme || "minimal");
        setDesign(u.prefs?.design || "grid");
        setBirthdate(u.birthdate || "");
        setContext(u.context || DEFAULT_CONTEXT);

        if (!u.birthdate) setFlow("setBirthdate");
        else setFlow("home");
      }, [session?.username]);

      // Update current user helper
      function updateCurrentUser(patch) {
        if (!session?.username) return;
        setUsers(prev => {
          const copy = { ...prev };
          const base = copy[session.username] || {};
          copy[session.username] = { ...base, ...patch };
          return copy;
        });
      }
      function updatePrefs(patch) {
        updateCurrentUser({ prefs: { ...(currentUser?.prefs || {}), ...patch } });
      }

      // keep prefs synced
      useEffect(() => { if (currentUser) updatePrefs({ lang }); }, [lang]);
      useEffect(() => { if (currentUser) updatePrefs({ theme }); }, [theme]);
      useEffect(() => { if (currentUser) updatePrefs({ design }); }, [design]);

      // compute stats
      const stats = useMemo(() => {
        if (!birthdate) return null;
        return computeStats(birthdate, context);
      }, [birthdate, context]);

      // daily insight selection (stable per user/day)
      const dailyInsights = useMemo(() => {
        if (!currentUser || !stats || stats.invalid) return null;
        const seed = hashToUint(currentUser.username + "|" + isoToday() + "|" + design + "|" + theme + "|" + lang);
        const rng = makeRng(seed);
        const pools = buildInsightPools(lang, stats, context);

        const intro = pickNUnique(introPool(lang), 1, rng)[0] || ["", ""];
        const social = pickNUnique(pools.social, 3, rng).map(fn => fn());
        const cosmic = pickNUnique(pools.cosmic, 3, rng).map(fn => fn());
        const nature = pickNUnique(pools.nature, 3, rng).map(fn => fn());
        return { intro, social, cosmic, nature };
      }, [currentUser?.username, stats, context, design, theme, lang]);

      // Mood modal once per day
      useEffect(() => {
        if (!currentUser || !birthdate) return;
        const today = isoToday();
        const moods = currentUser.moods || {};
        if (!moods[today]) setShowMoodModal(true);
      }, [currentUser?.username, birthdate]);

      // Birthday (once per day)
      useEffect(() => {
        if (!currentUser || !birthdate) return;
        if (!isBirthdayToday(birthdate)) { setShowBirthdayCard(false); return; }
        const today = isoToday();
        const lastShown = currentUser.birthdayShownISO;
        if (lastShown === today) { setShowBirthdayCard(false); return; }
        setShowBirthdayCard(true);
      }, [currentUser?.username, birthdate]);

      function dismissBirthdayCard() {
        setShowBirthdayCard(false);
        updateCurrentUser({ birthdayShownISO: isoToday() });
      }

      // ================== AUTH FLOW ==================
      async function doRegister() {
        setAuthMsg("");
        const u = authUser.trim();
        const p = authPass;
        if (!u || !p) return;

        if (users[u]) { setAuthMsg(lang === "es" ? "Ese usuario ya existe." : "That username already exists."); return; }

        const passHash = await passwordHash(u, p);
        const newUser = {
          version: 2,
          username: u,
          passHash,
          createdAt: Date.now(),
          birthdate: "",
          prefs: { lang: "es", theme: "minimal", design: "grid" },
          moods: {},
          context: { ...DEFAULT_CONTEXT },
          birthdayShownISO: null
        };

        setUsers(prev => ({ ...prev, [u]: newUser }));
        setSession({ username: u });
        setAuthUser(""); setAuthPass(""); setAuthMsg("");
        setFlow("setBirthdate");
      }

      async function doLogin() {
        setAuthMsg("");
        const u = authUser.trim();
        const p = authPass;
        if (!u || !p) return;

        const rec = users[u];
        if (!rec) { setAuthMsg(lang === "es" ? "Usuario o contraseÃ±a incorrectos." : "Wrong username or password."); return; }

        const passHash = await passwordHash(u, p);
        if (passHash !== rec.passHash) { setAuthMsg(lang === "es" ? "Usuario o contraseÃ±a incorrectos." : "Wrong username or password."); return; }

        setSession({ username: u });
        setAuthUser(""); setAuthPass(""); setAuthMsg("");
        setFlow(rec.birthdate ? "home" : "setBirthdate");
      }

      function logout() {
        setSession(null);
        setShowSettings(false);
        setExportCode("");
        setImportCode("");
        setImportMsg("");
        setFlow("welcome");
      }

      // ================== BIRTHDATE SET ==================
      function saveBirthdate() {
        setDateError("");
        if (!tempBirthdate) return;
        const s = computeStats(tempBirthdate, context);
        if (!s || s.invalid) { setDateError(t(s?.messageKey || "invalidFuture")); return; }
        setBirthdate(tempBirthdate);
        updateCurrentUser({ birthdate: tempBirthdate });
        setTempBirthdate("");
        setFlow("home");
      }

      // ================== MOODS ==================
      function saveMood(moodId) {
        if (!currentUser) return;
        const today = isoToday();
        const newMoods = { ...(currentUser.moods || {}), [today]: moodId };
        updateCurrentUser({ moods: newMoods });
        setShowMoodModal(false);
      }
      function moodHistory(lastDays=90) {
        const out = [];
        const moods = currentUser?.moods || {};
        const now = new Date();
        for (let i = lastDays - 1; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          const iso = `${y}-${m}-${day}`;
          out.push({ iso, id: moods[iso] || null });
        }
        return out;
      }

      // ================== EXPORT / IMPORT ==================
      function unicodeB64Encode(obj) {
        return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
      }
      function unicodeB64Decode(str) {
        return JSON.parse(decodeURIComponent(escape(atob(str))));
      }

      function doExport() {
        if (!currentUser) return;
        const payload = {
          app: "weeks-of-life",
          version: 2,
          exportedAt: Date.now(),
          user: currentUser,
        };
        setExportCode(unicodeB64Encode(payload));
        setCopyState("idle");
      }

      async function copyExport() {
        if (!exportCode) return;
        try {
          await navigator.clipboard.writeText(exportCode);
          setCopyState("copied");
          setTimeout(() => setCopyState("idle"), 1200);
        } catch {
          // fallback: let user select manually
          setCopyState("copied");
          setTimeout(() => setCopyState("idle"), 1200);
        }
      }

      function doImport() {
        setImportMsg("");
        try {
          const payload = unicodeB64Decode(importCode.trim());
          if (!payload || payload.app !== "weeks-of-life" || !payload.user?.username) throw new Error("bad");
          const u = payload.user.username;
          setUsers(prev => ({ ...prev, [u]: payload.user }));
          setImportMsg(lang === "es" ? "Perfil importado. Ahora inicia sesiÃ³n con tu usuario/contraseÃ±a." : "Profile imported. Now log in with your username/password.");
          setImportCode("");
        } catch {
          setImportMsg(lang === "es" ? "CÃ³digo invÃ¡lido." : "Invalid code.");
        }
      }

      // ================== SETTINGS UI (simple + accordion) ==================
      function SettingsScreen() {
        return (
          <div className={`min-h-screen safe-bottom ${themeColors.bg} ${themeColors.text} p-4`}>
            <div className="max-w-md mx-auto pt-8">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">{t("settings")}</h2>
                <button onClick={() => setShowSettings(false)} className={themeColors.textSecondary} aria-label={t("close")}>
                  <XIcon />
                </button>
              </div>

              <Accordion title={t("language")} themeColors={themeColors} defaultOpen={true}>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setLang("es")} className={`p-3 rounded-xl border ${themeColors.border} ${lang==="es" ? "ring-2 ring-black/20" : ""}`}>
                    {t("spanish")}
                  </button>
                  <button onClick={() => setLang("en")} className={`p-3 rounded-xl border ${themeColors.border} ${lang==="en" ? "ring-2 ring-black/20" : ""}`}>
                    {t("english")}
                  </button>
                </div>
              </Accordion>

              <Accordion title={t("theme")} themeColors={themeColors}>
                <div className="grid grid-cols-2 gap-2">
                  {Object.keys(THEMES).map(k => (
                    <button
                      key={k}
                      onClick={() => setTheme(k)}
                      className={`p-3 rounded-xl border ${themeColors.border} ${theme===k ? "ring-2 ring-black/20" : ""}`}
                    >
                      {THEMES[k].label[lang] || THEMES[k].label.en}
                    </button>
                  ))}
                </div>
              </Accordion>

              <Accordion title={t("design")} themeColors={themeColors}>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {id:"grid", label:{es:"CuadrÃ­cula", en:"Grid"}},
                    {id:"circle", label:{es:"Anillos", en:"Rings"}},
                    {id:"wave", label:{es:"Ondas", en:"Waves"}},
                    {id:"spiral", label:{es:"Espiral", en:"Spiral"}},
                    {id:"columns", label:{es:"Columnas", en:"Columns"}},
                    {id:"constellation", label:{es:"ConstelaciÃ³n", en:"Constellation"}},
                    {id:"snake", label:{es:"Serpiente", en:"Snake"}},
                  ].map(d => (
                    <button
                      key={d.id}
                      onClick={() => setDesign(d.id)}
                      className={`p-3 rounded-xl border ${themeColors.border} ${design===d.id ? "ring-2 ring-black/20" : ""}`}
                    >
                      {d.label[lang] || d.label.en}
                    </button>
                  ))}
                </div>
              </Accordion>

              <Accordion title={t("optionalNumbers")} themeColors={themeColors}>
                <div className={`${themeColors.textSecondary} text-xs mb-3`}>
                  {lang === "es" ? "Opcional. Si no tocas nada, usa valores por defecto." : "Optional. If you donâ€™t change anything, defaults are used."}
                </div>
                <div className="space-y-2">
                  <label className="text-sm">{t("populationAtBirth")}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                         value={context.populationAtBirth}
                         onChange={(e) => setContext(c => ({...c, populationAtBirth: e.target.value}))} />
                  <label className="text-sm">{t("populationNow")}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                         value={context.populationNow}
                         onChange={(e) => setContext(c => ({...c, populationNow: e.target.value}))} />
                  <label className="text-sm">{t("birthsPerYear")}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                         value={context.birthsPerYear}
                         onChange={(e) => setContext(c => ({...c, birthsPerYear: e.target.value}))} />
                  <label className="text-sm">{t("deathsPerYear")}</label>
                  <input className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`} inputMode="numeric"
                         value={context.deathsPerYear}
                         onChange={(e) => setContext(c => ({...c, deathsPerYear: e.target.value}))} />
                  <button
                    onClick={() => updateCurrentUser({ context: { ...context } })}
                    className={`mt-2 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-2 rounded-xl font-medium`}
                  >
                    {t("save")}
                  </button>
                </div>
              </Accordion>

              <Accordion title={t("profile")} themeColors={themeColors}>
                <div className={`${themeColors.textSecondary} text-xs mb-3`}>
                  <b>{t("exportHintTitle")}:</b> {t("exportHintBody")}
                </div>

                <div className="space-y-2">
                  <div className="text-sm">
                    {lang==="es" ? "SesiÃ³n:" : "Session:"} <b>{currentUser.username}</b>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <button
                      onClick={doImport}
                      className={`p-3 rounded-xl border ${themeColors.border} font-medium`}
                    >
                      {t("importData")}
                    </button>
                    <button
                      onClick={() => { setExportCode(""); setImportMsg(""); setImportCode(""); }}
                      className={`p-3 rounded-xl border ${themeColors.border} font-medium`}
                    >
                      {lang==="es" ? "Limpiar" : "Clear"}
                    </button>
                  </div>

                  <textarea
                    className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent text-xs`}
                    rows="4"
                    placeholder={lang==="es" ? "Pega aquÃ­ el cÃ³digo exportadoâ€¦" : "Paste exported code hereâ€¦"}
                    value={importCode}
                    onChange={(e) => setImportCode(e.target.value)}
                  />
                  {importMsg && <div className="text-sm">{importMsg}</div>}
                </div>
              </Accordion>

              {/* bottom: export + logout (as requested) */}
              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-4 mt-4`}>
                <div className="text-sm font-semibold mb-2">{lang==="es" ? "Al final" : "At the bottom"}</div>
                <div className={`${themeColors.textSecondary} text-xs mb-3`}>
                  {t("exportHintBody")}
                </div>

                <button
                  onClick={doExport}
                  className={`w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold`}
                >
                  {t("exportData")}
                </button>

                {exportCode && (
                  <div className="mt-3">
                    <textarea
                      className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent text-xs`}
                      rows="5"
                      value={exportCode}
                      readOnly
                      onFocus={(e) => e.target.select()}
                    />
                    <button
                      onClick={copyExport}
                      className={`mt-2 w-full p-3 rounded-xl border ${themeColors.border} font-medium`}
                    >
                      {copyState === "copied" ? t("copied") : t("copy")}
                    </button>
                  </div>
                )}

                <button
                  onClick={logout}
                  className="mt-3 w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold"
                >
                  {t("logout")}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // ================== DESIGNS ==================
      function weekColorFor(i) {
        const wl = stats?.weeksLivedClamped ?? 0;
        if (i < wl) return themeColors.hex.weekPast;
        if (i === wl) return themeColors.hex.weekCurrent;
        return themeColors.hex.weekFuture;
      }

      function renderGrid() {
        const weeksPerRow = 52;
        const cells = [];
        for (let i = 0; i < 4160; i++) {
          const isCurrent = i === stats.weeksLivedClamped;
          cells.push(
            <div key={i} className={"w-2 h-2 rounded-sm " + (isCurrent ? "animate-pulse" : "")}
                 style={{ backgroundColor: weekColorFor(i) }} />
          );
        }
        return (
          <div className="grid gap-[2px] justify-center" style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 0.5rem))` }}>
            {cells}
          </div>
        );
      }

      function renderCircle() {
        const W = 340, H = 340;
        const cx = W/2, cy = H/2;
        const rings = 80, perRing = 52;
        const maxR = 150, minR = 35;
        const step = (maxR - minR) / (rings - 1);
        const dots = [];
        for (let year = 0; year < rings; year++) {
          const r = minR + step * year;
          for (let w = 0; w < perRing; w++) {
            const idx = year * perRing + w;
            const ang = (w / perRing) * Math.PI * 2 - Math.PI/2;
            const x = cx + r * Math.cos(ang);
            const y = cy + r * Math.sin(ang);
            const isCurrent = idx === stats.weeksLivedClamped;
            dots.push(<circle key={idx} cx={x} cy={y} r={isCurrent ? 2.2 : 1.3} fill={weekColorFor(idx)} />);
          }
        }
        return (
          <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
            {dots}
            <text x={cx} y={cy - 4} textAnchor="middle" fontSize="32" fontWeight="800" fill={themeColors.hex.text}>
              {stats.percentageLived}%
            </text>
          </svg>
        );
      }

      function renderWave() {
        const weeksPerRow = 52;
        const bars = [];
        for (let i = 0; i < 4160; i++) {
          const col = i % weeksPerRow;
          const base = 6, amp = 10;
          const h = base + Math.round((Math.sin(col * 0.35) + 1) * 0.5 * amp);
          const isCurrent = i === stats.weeksLivedClamped;
          bars.push(
            <div key={i} className={"w-[6px] rounded-t " + (isCurrent ? "animate-pulse" : "")}
                 style={{ height: `${h}px`, backgroundColor: weekColorFor(i) }} />
          );
        }
        return (
          <div className="grid gap-[2px] justify-center items-end" style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 6px))` }}>
            {bars}
          </div>
        );
      }

      function renderSpiral() {
        const W = 340, H = 340;
        const cx = W/2, cy = H/2;
        const turns = 14, maxR = 150;
        const dots = [];
        for (let i = 0; i < 4160; i++) {
          const tt = i / 4159;
          const ang = tt * Math.PI * 2 * turns - Math.PI/2;
          const r = 10 + tt * (maxR - 10);
          const x = cx + r * Math.cos(ang);
          const y = cy + r * Math.sin(ang);
          const isCurrent = i === stats.weeksLivedClamped;
          dots.push(<circle key={i} cx={x} cy={y} r={isCurrent ? 2.4 : 1.1} fill={weekColorFor(i)} />);
        }
        return (
          <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
            {dots}
          </svg>
        );
      }

      function renderColumns() {
        // 80 columns (years), each with 52 small blocks stacked
        const cols = [];
        for (let y = 0; y < 80; y++) {
          const blocks = [];
          for (let w = 0; w < 52; w++) {
            const idx = y * 52 + w;
            const isCurrent = idx === stats.weeksLivedClamped;
            blocks.push(
              <div key={idx} className={"w-2 h-2 rounded-[2px] " + (isCurrent ? "animate-pulse" : "")}
                   style={{ backgroundColor: weekColorFor(idx) }} />
            );
          }
          cols.push(
            <div key={y} className="flex flex-col-reverse gap-[2px]">
              {blocks}
            </div>
          );
        }
        return (
          <div className="flex gap-[3px] justify-center overflow-x-auto pb-1">
            {cols}
          </div>
        );
      }

      function renderConstellation() {
        // scatter 4160 points in 340x340, stable by user/day
        const W=340,H=340;
        const seed = hashToUint(currentUser.username + "|" + birthdate);
        const rng = makeRng(seed);
        const pts = [];
        for (let i=0;i<4160;i++) {
          // distribute in circle-ish
          const a = rng()*Math.PI*2;
          const r = Math.sqrt(rng()) * 150;
          const x = W/2 + r*Math.cos(a);
          const y = H/2 + r*Math.sin(a);
          const isCurrent = i === stats.weeksLivedClamped;
          pts.push(<circle key={i} cx={x} cy={y} r={isCurrent?2.6:1.1} fill={weekColorFor(i)} opacity={isCurrent?1:0.9} />);
        }
        return (
          <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="mx-auto block">
            {pts}
          </svg>
        );
      }

      function renderSnake() {
        // grid 52 columns, snake ordering by rows
        const weeksPerRow = 52;
        const cells = [];
        for (let row=0; row<80; row++) {
          for (let col=0; col<52; col++) {
            const idx = row%2===0 ? (row*52 + col) : (row*52 + (51-col));
            const isCurrent = idx === stats.weeksLivedClamped;
            cells.push(
              <div key={row+"-"+col} className={"w-2 h-2 rounded-sm " + (isCurrent ? "animate-pulse" : "")}
                   style={{ backgroundColor: weekColorFor(idx) }} />
            );
          }
        }
        return (
          <div className="grid gap-[2px] justify-center" style={{ gridTemplateColumns: `repeat(${weeksPerRow}, minmax(0, 0.5rem))` }}>
            {cells}
          </div>
        );
      }

      function renderDesign() {
        if (!stats || stats.invalid) return null;
        switch(design) {
          case "grid": return renderGrid();
          case "circle": return renderCircle();
          case "wave": return renderWave();
          case "spiral": return renderSpiral();
          case "columns": return renderColumns();
          case "constellation": return renderConstellation();
          case "snake": return renderSnake();
          default: return renderGrid();
        }
      }

      // ================== MAIN CARDS ==================
      function InfoCard({ title, lines, defaultOpen=false }) {
        return (
          <Accordion title={title} defaultOpen={defaultOpen} themeColors={themeColors}>
            <ul className={`space-y-2 ${themeColors.textSecondary}`}>
              {lines.map((l,i) => <li key={i} className="text-sm leading-relaxed">â€¢ {l}</li>)}
            </ul>
          </Accordion>
        );
      }

      // ================== ONBOARDING ==================
      function Onboarding() {
        return (
          <div className={`min-h-screen safe-bottom ${themeColors.bg} ${themeColors.text} flex items-center justify-center p-4`}>
            <div className="max-w-md w-full">
              <h1 className="text-3xl font-bold text-center">{t("onboardingTitle")}</h1>
              <p className={`${themeColors.textSecondary} text-center mt-2 mb-6`}>{t("onboardingSubtitle")}</p>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5`}>
                {flow === "welcome" && (
                  <div className="space-y-3 fade-in">
                    <div className="font-semibold">{t("chooseAuth")}</div>
                    <button
                      onClick={() => setFlow("register")}
                      className={`w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold`}
                    >
                      {t("createNew")}
                    </button>
                    <button
                      onClick={() => setFlow("login")}
                      className={`w-full border ${themeColors.border} py-3 rounded-xl font-semibold`}
                    >
                      {t("alreadyHave")}
                    </button>

                    <div className="mt-4">
                      <div className={`${themeColors.textSecondary} text-xs mb-2`}>{t("exportHintTitle")}</div>
                      <textarea
                        className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent text-xs`}
                        rows="3"
                        placeholder={lang==="es" ? "Pega aquÃ­ un cÃ³digo exportado (opcional)â€¦" : "Paste an exported code (optional)â€¦"}
                        value={importCode}
                        onChange={(e) => setImportCode(e.target.value)}
                      />
                      <button onClick={doImport} className={`mt-2 w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                        {t("importData")}
                      </button>
                      {importMsg && <div className="mt-2 text-sm">{importMsg}</div>}
                    </div>

                    <div className="mt-4">
                      <button onClick={() => setShowSettings(true)} className={`w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                        {t("settings")}
                      </button>
                    </div>
                  </div>
                )}

                {(flow === "register" || flow === "login") && (
                  <div className="space-y-3 fade-in">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">{flow === "register" ? t("register") : t("login")}</div>
                      <button onClick={() => setFlow("welcome")} className={themeColors.textSecondary}>{t("back")}</button>
                    </div>

                    <input
                      className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                      placeholder={t("username")}
                      value={authUser}
                      onChange={(e) => setAuthUser(e.target.value)}
                      autoCapitalize="none"
                      autoCorrect="off"
                    />
                    <input
                      className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                      placeholder={t("password")}
                      type="password"
                      value={authPass}
                      onChange={(e) => setAuthPass(e.target.value)}
                    />

                    {authMsg && <div className="text-sm text-red-600">{authMsg}</div>}

                    <button
                      onClick={flow === "register" ? doRegister : doLogin}
                      className={`w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold`}
                    >
                      {flow === "register" ? t("register") : t("login")}
                    </button>

                    <button onClick={() => setShowSettings(true)} className={`w-full p-3 rounded-xl border ${themeColors.border} font-medium`}>
                      {t("settings")}
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      function BirthdateStep() {
        return (
          <div className={`min-h-screen safe-bottom ${themeColors.bg} ${themeColors.text} flex items-center justify-center p-4`}>
            <div className="max-w-md w-full">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <div className="text-2xl font-bold">{t("setBirthdate")}</div>
                  <div className={`${themeColors.textSecondary} text-sm`}>{currentUser?.username}</div>
                </div>
                <button onClick={() => setShowSettings(true)} className={themeColors.textSecondary} aria-label={t("settings")}>
                  <SettingsIcon />
                </button>
              </div>

              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5`}>
                <label className="block mb-2 font-medium">{t("whenBorn")}</label>
                <input
                  type="date"
                  className={`w-full p-3 rounded-xl border ${themeColors.border} bg-transparent`}
                  value={tempBirthdate}
                  onChange={(e) => setTempBirthdate(e.target.value)}
                />
                {dateError && <div className="mt-2 text-sm text-red-600">{dateError}</div>}

                <button
                  onClick={saveBirthdate}
                  disabled={!tempBirthdate}
                  className={`mt-3 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-3 rounded-xl font-semibold disabled:opacity-50`}
                >
                  {t("done")}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // ================== HOME ==================
      function Home() {
        if (!stats || stats.invalid) return null;

        const moodCells = moodHistory(90);
        const intro = dailyInsights?.intro || ["", ""];
        const socialLines = dailyInsights?.social || [];
        const cosmicLines = dailyInsights?.cosmic || [];
        const natureLines = dailyInsights?.nature || [];

        const letter = birthdayLetter(lang, currentUser, stats);

        return (
          <div className={`min-h-screen safe-bottom ${themeColors.bg} ${themeColors.text}`}>
            {/* birthday card */}
            {showBirthdayCard && (
              <div className="max-w-md mx-auto p-4 pt-5">
                <div className="rounded-2xl p-4 border border-black/10 fade-in"
                     style={{
                       background: "linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.55))",
                     }}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 font-semibold">
                      <PartyIcon /> {t("birthdayTitle")}
                    </div>
                    <button onClick={dismissBirthdayCard} className="text-sm text-gray-600">
                      {t("birthdayDismiss")}
                    </button>
                  </div>
                  <div className="text-sm text-gray-700 mt-2">
                    {lang==="es" ? "Tienes una carta hecha con tus emociones del aÃ±o." : "You have a letter based on your yearâ€™s moods."}
                  </div>
                  <button
                    onClick={() => { setShowBirthdayModal(true); updateCurrentUser({ birthdayShownISO: isoToday() }); setShowBirthdayCard(false); }}
                    className={`mt-3 w-full ${themeColors.accent} ${themeColors.accentHover} text-white py-2 rounded-xl font-semibold`}
                  >
                    {t("birthdayOpen")}
                  </button>
                </div>
              </div>
            )}

            <div className="max-w-md mx-auto p-4 pt-8">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h1 className="text-2xl font-bold">{t("yourLife")}</h1>
                  <p className={themeColors.textSecondary + " text-sm"}>
                    {stats.yearsLived} {lang==="es" ? "aÃ±os" : "years"}, {stats.monthsLived} {lang==="es" ? "meses" : "months"}
                  </p>
                </div>
                <button onClick={() => setShowSettings(true)} className={themeColors.textSecondary} aria-label={t("settings")}>
                  <SettingsIcon />
                </button>
              </div>

              {/* rotating intro */}
              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-4 mb-4`}>
                <div className="text-sm font-semibold">{intro[0]}</div>
                <div className={`${themeColors.textSecondary} text-sm mt-1`}>{intro[1]}</div>
              </div>

              {/* main design */}
              <div className={`${themeColors.card} border ${themeColors.border} rounded-2xl p-5 mb-4`}>
                {renderDesign()}
              </div>

              {/* quick stats */}
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div className={`${themeColors.card} border ${themeColors.border} p-4 rounded-2xl`}>
                  <div className={`${themeColors.textSecondary} text-sm`}>{t("weeksLived")}</div>
                  <div className="text-2xl font-bold">{stats.weeksLived.toLocaleString()}</div>
                </div>
                <div className={`${themeColors.card} border ${themeColors.border} p-4 rounded-2xl`}>
                  <div className={`${themeColors.textSecondary} text-sm`}>{t("daysLived")}</div>
                  <div className="text-2xl font-bold">{stats.daysLived.toLocaleString()}</div>
                </div>
              </div>

              {/* progress */}
              <div className={`${themeColors.card} border ${themeColors.border} p-6 rounded-2xl mb-4`}>
                <div className="flex justify-between items-center mb-2">
                  <span className={themeColors.textSecondary}>{t("lifeProgress")}</span>
                  <span className="text-2xl font-bold">{stats.percentageLived}%</span>
                </div>
                <div className={`w-full rounded-full h-3 overflow-hidden ${themeColors.track}`}>
                  <div className={`${themeColors.accent} h-full rounded-full transition-all duration-700`} style={{ width: `${stats.percentageLived}%` }} />
                </div>
                <div className={`${themeColors.textSecondary} text-sm mt-3`}>
                  {t("weeksLeft")} {stats.weeksRemaining.toLocaleString()} {t("weeks")}
                </div>
              </div>

              {/* mood */}
              <div className={`${themeColors.card} border ${themeColors.border} p-6 rounded-2xl mb-4`}>
                <div className="flex justify-between items-center mb-2">
                  <span className="font-semibold">{t("mood")}</span>
                  <span className={`${themeColors.textSecondary} text-xs`}>{t("history90")}</span>
                </div>

                <div className="grid grid-cols-15 gap-[3px]" style={{ gridTemplateColumns: "repeat(15, minmax(0, 1fr))" }}>
                  {moodCells.map((d) => {
                    const mood = moodById(d.id);
                    const col = mood ? mood.color : (theme === "dark" || theme === "neon" ? "#0b0b0f" : "#e5e7eb");
                    return (
                      <div key={d.iso} className="w-full aspect-square rounded-[3px]"
                           style={{ backgroundColor: col }}
                           title={`${d.iso}${mood ? " Â· " + (mood.label[lang] || mood.label.en) : ""}`} />
                    );
                  })}
                </div>

                <button
                  onClick={() => setShowMoodModal(true)}
                  className={`mt-4 w-full p-3 rounded-xl border ${themeColors.border} font-semibold`}
                >
                  {t("moodLogNow")}
                </button>
              </div>

              {/* collapsible context (rotating) */}
              <InfoCard title={t("societal")} lines={socialLines} defaultOpen={false} />
              <InfoCard title={t("cosmic")} lines={cosmicLines} defaultOpen={false} />
              <InfoCard title={t("nature")} lines={natureLines} defaultOpen={false} />

              {/* footer */}
              <div className={`${themeColors.textSecondary} text-xs text-center mt-6`}>
                {currentUser.username} Â· {design} Â· {theme}
              </div>
            </div>

            {/* Mood modal */}
            <Modal open={showMoodModal} onClose={() => setShowMoodModal(false)}>
              <div className="mb-2 text-lg font-bold">{t("moodTodayTitle")}</div>
              <div className="text-sm text-gray-600 mb-3">{t("moodTodaySubtitle")}</div>
              <div className="grid grid-cols-2 gap-2">
                {MOODS.map(m => (
                  <PillButton key={m.id} label={m.label[lang] || m.label.en} color={m.color} onClick={() => saveMood(m.id)} />
                ))}
              </div>
              <button onClick={() => setShowMoodModal(false)} className="mt-3 w-full p-3 rounded-xl border border-black/10 font-medium">
                {t("skip")}
              </button>
            </Modal>

            {/* Birthday letter modal */}
            <Modal open={showBirthdayModal} onClose={() => setShowBirthdayModal(false)}>
              <div className="rounded-2xl p-4 border border-black/10"
                   style={{
                     background: "linear-gradient(135deg, rgba(255,245,235,0.95), rgba(240,253,250,0.85))"
                   }}>
                <div className="flex items-center gap-2 font-semibold mb-2">
                  <PartyIcon /> {t("birthdayLetter")}
                </div>
                <Markdownish text={letter} themeColors={{...themeColors, textSecondary:"text-gray-700"}} />
              </div>
            </Modal>
          </div>
        );
      }

      // ================== RENDER ROUTER ==================
      if (showSettings && currentUser) return <SettingsScreen />;

      if (!currentUser) return <Onboarding />;
      if (flow === "setBirthdate" || !birthdate) return <BirthdateStep />;
      return <Home />;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
